<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Impact Financial Needs Analysis (FNA)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
            min-height: 100vh;
            color: #ffffff;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.85);
            min-height: 100vh;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.3);
            border: 1px solid #b19777;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        /* Replace this placeholder with actual logo */
        .logo-placeholder {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
        }
        
        .header-text {
            flex: 1;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .file-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .file-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .file-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .tab-container {
            display: flex;
            background: #1a1a1a;
            border-bottom: 1px solid #b19777;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #cccccc;
            position: relative;
            user-select: none;
            background: transparent;
            border: none;
            outline: none;
        }
        
        .tab:hover {
            background: rgba(177, 151, 119, 0.1);
            color: #b19777;
        }
        
        .tab.active {
            background: rgba(0, 0, 0, 0.7);
            color: #b19777;
            border-bottom-color: #b19777;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid #b19777;
        }
        
        .form-section h3 {
            color: #b19777;
            margin-bottom: 15px;
            font-size: 1.4em;
            padding-bottom: 8px;
            border-bottom: 2px solid #b19777;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .form-row-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .form-row-6 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .partner-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.1));
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #b19777;
        }
        
        .partner-section h4 {
            color: #b19777;
            margin-bottom: 15px;
            font-size: 1.2em;
            text-align: center;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #b19777;
            font-size: 0.95em;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #666;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #444;
            color: #ffffff;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #b19777;
            background: #555;
            box-shadow: 0 0 0 3px rgba(177, 151, 119, 0.2);
        }
        
        /* Remove spinner buttons from Other Income Sources numeric fields */
        .income-amount::-webkit-outer-spin-button,
        .income-amount::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .income-amount[type=number] {
            -moz-appearance: textfield;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        .goal-item {
            display: grid;
            grid-template-columns: 1.5fr 1.5fr 0.7fr 1fr 0.8fr 0.3fr;
            gap: 8px;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #444;
        }
        
        .income-item {
            display: grid;
            grid-template-columns: 2fr 1.5fr 2fr 1fr;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #444;
        }
        
        .liability-item, .asset-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #444;
        }
        
        .add-btn {
            background: linear-gradient(135deg, #b19777, #c9a96e);
            color: #1a1a1a;
            border: none;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            font-weight: 500;
            height: 46px;
            transition: all 0.3s ease;
        }
        
        .add-btn:hover {
            background: linear-gradient(135deg, #c9a96e, #d4b876);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(177, 151, 119, 0.3);
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #b19777, #c9a96e);
            color: #1a1a1a;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px auto;
            display: block;
            box-shadow: 0 5px 15px rgba(177, 151, 119, 0.3);
        }
        
        .calculate-btn:hover {
            background: linear-gradient(135deg, #c9a96e, #d4b876);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(177, 151, 119, 0.4);
        }
        
        .results-section {
            background: #444;
            color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            margin-top: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid #b19777;
        }
        
        .results-section h4 {
            color: #c9a96e;
            margin-bottom: 20px;
        }
        
        .results-section h5 {
            color: #b19777;
        }
        
        .fin-display {
            text-align: center;
            background: linear-gradient(135deg, #b19777, #c9a96e);
            color: #1a1a1a;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(177, 151, 119, 0.3);
        }
        
        .fin-number {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
            color: #1a1a1a;
        }
        
        .scenario-tabs {
            display: flex;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 5px;
        }
        
        .scenario-tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .scenario-tab.active {
            background: #b19777;
            color: #1a1a1a;
            box-shadow: 0 2px 8px rgba(177, 151, 119, 0.3);
        }
        
        .chart-container {
            background: #444;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid #666;
            height: 400px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .summary-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #b19777;
            border: 1px solid #444;
        }
        
        .summary-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #b19777;
            margin-bottom: 5px;
        }
        
        .summary-card .label {
            color: #cccccc;
            font-size: 0.9em;
        }
        
        .print-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            margin: 20px 0;
        }
        
        .print-btn:hover {
            background: #218838;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .print-summary, .print-summary * {
                visibility: visible;
            }
            .print-summary {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .tab-container {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                font-size: 0.9em;
                padding: 12px 15px;
            }
            
            .form-row, .form-row-3, .form-row-4, .form-row-6 {
                grid-template-columns: 1fr;
            }
            
            .goal-item, .income-item, .liability-item, .asset-item {
                grid-template-columns: 1fr;
            }
        }
        
        .hidden {
            display: none;
        }
        
        /* Percentage symbol styling */
        .percentage-symbol {
            font-weight: bold;
            color: #b19777;
            margin-left: 5px;
            font-size: 1.1em;
        }
        
        /* Specific layout for liability items with smaller interest rate field */
        .liability-item {
            grid-template-columns: 1fr 1fr 0.6fr 1fr !important;
        }
        
        /* Remove button styling */
        .remove-btn {
            background: linear-gradient(135deg, #b19777, #c9a96e) !important;
            color: #1a1a1a !important;
            border: none !important;
            padding: 12px 15px !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            height: 46px !important;
            transition: all 0.3s ease !important;
        }
        
        .remove-btn:hover {
            background: linear-gradient(135deg, #c9a96e, #d4b876) !important;
            transform: translateY(-1px) !important;
        }
        
        /* Specific styling for debt section remove buttons */
        .secured-debt .remove-btn,
        .unsecured-debt .remove-btn {
            padding: 6px 8px !important;
            min-width: 28px !important;
            width: 28px !important;
            height: 28px !important;
            font-size: 14px !important;
            line-height: 1 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            margin: 0 !important;
            flex-shrink: 0 !important;
        }
        
        /* Ensure debt sections maintain grid layout */
        .secured-debt,
        .unsecured-debt {
            align-items: center !important;
            min-height: 40px !important;
        }
        
        .secured-debt > *,
        .unsecured-debt > * {
            margin: 0 !important;
            overflow: hidden !important;
            white-space: nowrap !important;
        }
        
        /* Ensure form elements don't exceed their grid cell */
        .secured-debt input,
        .secured-debt select,
        .unsecured-debt input,
        .unsecured-debt select {
            max-width: 100% !important;
            box-sizing: border-box !important;
        }
        
        /* Priority goal checkboxes styling */
        .priority-goal[type="checkbox"] {
            width: 18px !important;
            height: 18px !important;
            background: #444 !important;
            border: 2px solid #666 !important;
            border-radius: 4px !important;
            appearance: none !important;
            -webkit-appearance: none !important;
            cursor: pointer !important;
            position: relative !important;
            margin: 0 !important;
        }
        
        .priority-goal[type="checkbox"]:checked {
            background: linear-gradient(135deg, #b19777, #c9a96e) !important;
            border-color: #b19777 !important;
        }
        
        .priority-goal[type="checkbox"]:checked::after {
            content: '✓' !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            color: #1a1a1a !important;
            font-weight: bold !important;
            font-size: 12px !important;
        }
        
        .priority-goal[type="checkbox"]:hover {
            border-color: #b19777 !important;
            background: #555 !important;
        }
        
        .priority-goal[type="checkbox"]:focus {
            outline: none !important;
            box-shadow: 0 0 0 3px rgba(177, 151, 119, 0.2) !important;
        }
        
        /* Mortgage item styling */
        .mortgage-item {
            display: grid;
            grid-template-columns: 1fr 1fr 0.8fr 0.8fr 1fr 1fr 1fr;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
        }
        
        .mortgage-item input, .mortgage-item select {
            background: #444 !important;
            color: #ffffff !important;
            border: 1px solid #666 !important;
            padding: 12px 15px !important;
            border-radius: 8px !important;
            font-size: 14px !important;
        }
        
        .mortgage-item input:focus, .mortgage-item select:focus {
            background: #555 !important;
            border-color: #b19777 !important;
            box-shadow: 0 0 0 3px rgba(177, 151, 119, 0.2) !important;
        }
        
        .mortgage-item input[readonly] {
            background: rgba(177, 151, 119, 0.1) !important;
            color: #b19777 !important;
            font-weight: 600 !important;
        }
        
        /* Secured and unsecured debt styling */
        .secured-debt input, .secured-debt select,
        .unsecured-debt input, .unsecured-debt select {
            background: #444 !important;
            color: #ffffff !important;
            border: 1px solid #666 !important;
            padding: 12px 15px !important;
            border-radius: 8px !important;
            font-size: 14px !important;
        }
        
        .secured-debt input:focus, .secured-debt select:focus,
        .unsecured-debt input:focus, .unsecured-debt select:focus {
            background: #555 !important;
            border-color: #b19777 !important;
            box-shadow: 0 0 0 3px rgba(177, 151, 119, 0.2) !important;
        }
        
        /* Comprehensive styling for all form elements */
        .income-item input, .income-item select,
        .goal-item input, .goal-item select,
        .asset-item input, .asset-item select {
            background: #444 !important;
            color: #ffffff !important;
            border: 1px solid #666 !important;
            padding: 12px 15px !important;
            border-radius: 8px !important;
            font-size: 14px !important;
        }
        
        .income-item input:focus, .income-item select:focus,
        .goal-item input:focus, .goal-item select:focus,
        .asset-item input:focus, .asset-item select:focus {
            background: #555 !important;
            border-color: #b19777 !important;
            box-shadow: 0 0 0 3px rgba(177, 151, 119, 0.2) !important;
        }
        
        
        /* Layout adjustments for debt sections - all fields on same row */
        .secured-debt, .unsecured-debt {
            display: grid !important;
            grid-template-columns: 1.2fr 0.7fr 0.4fr 0.7fr 60px !important;
            gap: 8px !important;
            margin-bottom: 10px;
            padding: 8px 0;
            align-items: center !important;
        }
        
        /* Force debt items to stay inline */
        .liability-item.secured-debt,
        .liability-item.unsecured-debt {
            display: grid !important;
            grid-template-columns: 1.2fr 0.7fr 0.4fr 0.7fr 60px !important;
            gap: 6px !important;
            margin-bottom: 10px;
            padding: 8px 0;
            align-items: center !important;
        }
        
        .secured-debt select, .secured-debt input,
        .unsecured-debt select, .unsecured-debt input {
            width: 100% !important;
            margin-bottom: 0 !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
        }
        
        /* Specific width constraints for better fit */
        .secured-debt .liability-type, .unsecured-debt .liability-type {
            min-width: 120px !important;
        }
        
        .secured-debt .liability-rate, .unsecured-debt .liability-rate {
            min-width: 80px !important;
        }
        
        /* Additional CSS to prevent field wrapping */
        .secured-debt > *, .unsecured-debt > * {
            grid-column: auto !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* Override any conflicting form styles */
        .form-section .secured-debt,
        .form-section .unsecured-debt {
            display: grid !important;
            grid-template-columns: 1.2fr 0.7fr 0.4fr 0.7fr 60px !important;
            gap: 8px !important;
        }
        
        /* Results page styling */
        #calculationResults {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }
        
        .scenario-tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .scenario-tab {
            padding: 12px 24px;
            background: #444;
            color: #cccccc;
            border: 1px solid #666;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .scenario-tab:hover {
            background: #555;
            border-color: #b19777;
            color: #ffffff;
        }
        
        .scenario-tab.active {
            background: linear-gradient(135deg, #b19777, #c9a96e);
            color: #1a1a1a;
            border-color: #b19777;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(177, 151, 119, 0.3);
        }
        
        /* 3x3 FIN Matrix Styling */
        .fin-matrix {
            background: #333;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        
        .matrix-header {
            display: grid;
            grid-template-columns: 200px 1fr 1fr 1fr;
            background: linear-gradient(135deg, #b19777, #c9a96e);
            color: #1a1a1a;
            font-weight: 600;
        }
        
        .matrix-corner {
            padding: 15px;
            background: rgba(0,0,0,0.1);
            border-right: 1px solid rgba(0,0,0,0.2);
        }
        
        .tax-header {
            padding: 15px;
            text-align: center;
            border-right: 1px solid rgba(0,0,0,0.2);
            font-size: 0.9em;
        }
        
        .tax-header:last-child {
            border-right: none;
        }
        
        .tax-header small {
            font-size: 0.8em;
            opacity: 0.8;
            font-weight: 400;
        }
        
        .matrix-row {
            display: grid;
            grid-template-columns: 200px 1fr 1fr 1fr;
            border-bottom: 1px solid #555;
        }
        
        .matrix-row:last-child {
            border-bottom: none;
        }
        
        .scenario-header {
            padding: 20px 15px;
            background: #444;
            border-right: 1px solid #555;
            display: flex;
            flex-direction: column;
            justify-content: center;
            color: #c9a96e;
            font-size: 0.9em;
        }
        
        .scenario-header strong {
            color: #ffffff;
            margin-bottom: 5px;
        }
        
        .scenario-header small {
            color: #cccccc;
            font-size: 0.8em;
        }
        
        .fin-cell {
            padding: 20px 15px;
            background: #2a2a2a;
            border-right: 1px solid #555;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .fin-cell:last-child {
            border-right: none;
        }
        
        .fin-cell:hover {
            background: #3a3a3a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(177, 151, 119, 0.2);
        }
        
        .fin-cell.selected {
            background: #3a3a3a;
            border: 2px solid #c9a96e;
            box-shadow: 0 5px 15px rgba(177, 151, 119, 0.4);
        }
        
        .fin-amount {
            font-size: 1.4em;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 8px;
        }
        
        .monthly-amount {
            font-size: 0.9em;
            color: #c9a96e;
            font-weight: 500;
        }
        
        /* Responsive adjustments for matrix */
        @media (max-width: 1200px) {
            .matrix-header,
            .matrix-row {
                grid-template-columns: 180px 1fr 1fr 1fr;
            }
            
            .fin-amount {
                font-size: 1.2em;
            }
            
            .monthly-amount {
                font-size: 0.8em;
            }
        }
        
        @media (max-width: 900px) {
            .matrix-header,
            .matrix-row {
                grid-template-columns: 1fr;
            }
            
            .matrix-header {
                display: none;
            }
            
            .matrix-row {
                border: 1px solid #555;
                border-radius: 8px;
                margin-bottom: 15px;
                overflow: hidden;
            }
            
            .scenario-header {
                border-right: none;
                border-bottom: 1px solid #555;
                text-align: center;
            }
            
            .fin-cell {
                border-right: none;
                border-bottom: 1px solid #555;
            }
            
            .fin-cell:last-child {
                border-bottom: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-section">
                <!-- Replace this div with actual logo image -->
                <!-- Recommended logo dimensions: 60px x 60px or proportional -->
                <div class="logo-placeholder">FNA</div>
                <div class="header-text">
                    <h1>Financial Needs Analysis</h1>
                    <p>Comprehensive Financial Planning Tool</p>
                </div>
            </div>
            <div class="file-controls">
                <button class="file-btn" onclick="saveData()">💾 Save</button>
                <input type="file" id="fileInput" accept=".json" style="display: none;"><!-- Removed inline onchange to avoid reference error - event listener added in JavaScript -->
                <button class="file-btn" onclick="document.getElementById('fileInput').click()">📁 Load</button>
            </div>
        </div>
        
        <div class="tab-container">
            <div class="tab active" onclick="switchTab('family')">👨‍👩‍👧‍👦 Family</div>
            <div class="tab" onclick="switchTab('income')">💰 Income</div>
            <div class="tab" onclick="switchTab('assumptions')">📊 Assumptions</div>
            <div class="tab" onclick="switchTab('goals')">🎯 Goals</div>
            <div class="tab" onclick="switchTab('assets')">📈 Assets</div>
            <div class="tab" onclick="switchTab('liabilities')">💳 Liabilities</div>
            <div class="tab" onclick="switchTab('insurance')">🛡️ Insurance</div>
            <div class="tab" onclick="switchTab('results')">📋 Results</div>
        </div>
        
        <!-- Family Tab -->
        <div id="family" class="tab-content active">
            <div class="form-section">
                <h3>👨‍👩‍👧‍👦 Family Information</h3>
                
                <div class="form-row">
                    <!-- Partner 1 Section -->
                    <div class="partner-section">
                        <h4 id="partner1Header">👤 Partner 1</h4>
                        
                        <!-- Row 1: Name and Date of Birth -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="spouse1Name">Full Name:</label>
                                <input type="text" id="spouse1Name" placeholder="Full Name" onchange="updatePartnerNames()">
                            </div>
                            <div class="form-group">
                                <label for="spouse1DOB">Date of Birth:</label>
                                <input type="text" id="spouse1DOB" placeholder="YYYYMMDD" oninput="formatDateInput(this)" onchange="updateLifeExpectancyFromAge('spouse1'); calculateIncomeReplacementYears()">
                            </div>
                        </div>
                        
                        <!-- Row 2: Gender, Retirement Age, Life Expectancy -->
                        <div class="form-row-3" style="grid-template-columns: 0.8fr 0.6fr 0.6fr;">
                            <div class="form-group">
                                <label for="spouse1Gender">Gender:</label>
                                <select id="spouse1Gender" onchange="updateLifeExpectancy('spouse1')">
                                    <option value="">Select</option>
                                    <option value="male" selected>Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="spouse1RetireAge">Retirement Age:</label>
                                <input type="number" id="spouse1RetireAge" min="50" max="80" value="65" onchange="calculateIncomeReplacementYears()">
                            </div>
                            <div class="form-group">
                                <label for="spouse1LifeExpectancy">Life Expectancy:</label>
                                <input type="number" id="spouse1LifeExpectancy" min="65" max="110" value="85">
                                <small style="color: white;"><a href="https://www.statcan.gc.ca/en/dai/btd/othervisuals/other006" target="_blank" style="color: white;">Statistics Canada Life Tables</a></small>
                            </div>
                        </div>
                        
                        <!-- Row 3: Email and Phone -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="spouse1Email">Email Address:</label>
                                <input type="email" id="spouse1Email" placeholder="email@example.com">
                                <small style="color: #cccccc;">For sending report copy</small>
                            </div>
                            <div class="form-group">
                                <label for="spouse1Phone">Phone Number:</label>
                                <input type="tel" id="spouse1Phone" placeholder="(403)-555-1234" oninput="formatPhoneNumber(this)">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Partner 2 Section -->
                    <div class="partner-section">
                        <h4 id="partner2Header">👤 Partner 2</h4>
                        
                        <!-- Row 1: Name and Date of Birth -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="spouse2Name">Full Name:</label>
                                <input type="text" id="spouse2Name" placeholder="Full Name" onchange="updatePartnerNames()">
                            </div>
                            <div class="form-group">
                                <label for="spouse2DOB">Date of Birth:</label>
                                <input type="text" id="spouse2DOB" placeholder="YYYYMMDD" oninput="formatDateInput(this)" onchange="updateLifeExpectancyFromAge('spouse2'); calculateIncomeReplacementYears()">
                            </div>
                        </div>
                        
                        <!-- Row 2: Gender, Retirement Age, Life Expectancy -->
                        <div class="form-row-3" style="grid-template-columns: 0.8fr 0.6fr 0.6fr;">
                            <div class="form-group">
                                <label for="spouse2Gender">Gender:</label>
                                <select id="spouse2Gender" onchange="updateLifeExpectancy('spouse2')">
                                    <option value="">Select</option>
                                    <option value="male">Male</option>
                                    <option value="female" selected>Female</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="spouse2RetireAge">Retirement Age:</label>
                                <input type="number" id="spouse2RetireAge" min="50" max="80" value="65" onchange="calculateIncomeReplacementYears()">
                            </div>
                            <div class="form-group">
                                <label for="spouse2LifeExpectancy">Life Expectancy:</label>
                                <input type="number" id="spouse2LifeExpectancy" min="65" max="110" value="85">
                                <small style="color: white;"><a href="https://www.statcan.gc.ca/en/dai/btd/othervisuals/other006" target="_blank" style="color: white;">Statistics Canada Life Tables</a></small>
                            </div>
                        </div>
                        
                        <!-- Row 3: Email and Phone -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="spouse2Email">Email Address:</label>
                                <input type="email" id="spouse2Email" placeholder="email@example.com">
                                <small style="color: #cccccc;">For sending report copy</small>
                            </div>
                            <div class="form-group">
                                <label for="spouse2Phone">Phone Number:</label>
                                <input type="tel" id="spouse2Phone" placeholder="(403)-555-1234" oninput="formatPhoneNumber(this)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>👶 Dependents</h3>
                <p style="color: #cccccc; margin-bottom: 15px; font-size: 0.9em;">
                    <strong>Note:</strong> Current average cost of university in Canada (living at home): 
                    <strong>$12,000-$15,000/year</strong> including tuition, books, and minimal living expenses.
                </p>
                <div id="dependentsList">
                    <div class="dependent-item" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 0.3fr; gap: 8px; align-items: center;">
                        <div class="form-group">
                            <label>Child Name:</label>
                            <input type="text" class="dependent-name" placeholder="Child's Name">
                        </div>
                        <div class="form-group">
                            <label>Date of Birth:</label>
                            <input type="text" class="dependent-dob" placeholder="YYYYMMDD" oninput="formatDateInput(this)">
                        </div>
                        <div class="form-group">
                            <label>Post-Secondary Start Age:</label>
                            <input type="number" class="dependent-edu-age" value="18" min="16" max="25">
                        </div>
                        <div class="form-group">
                            <label>Years of Study:</label>
                            <input type="number" class="dependent-study-years" value="4" min="1" max="8">
                        </div>
                        <div class="form-group">
                            <label>Annual Education Cost:</label>
                            <input type="text" class="dependent-edu-cost" value="$12,000.00" oninput="formatCurrency(this)" onblur="formatCurrencyComplete(this)">
                        </div>
                        <button class="remove-btn" onclick="removeDependent(this)" title="Remove this dependent">×</button>
                    </div>
                </div>
                <button class="add-btn" onclick="addDependent()">+ Add Dependent</button>
            </div>
        </div>
        
        <!-- Income Tab -->
        <div id="income" class="tab-content">
            <div class="form-section">
                <h3 id="partner1IncomeTitle">💰 Partner 1 Income - $0 per year</h3>
                <p style="color: #cccccc; margin-bottom: 15px; font-size: 0.9em;">Enter net "take-home" amounts after taxes and deductions</p>
                <div class="form-row-3">
                    <div class="form-group">
                        <label for="income1Rate">Net Take-Home Pay Rate ($):</label>
                        <input type="text" id="income1Rate" placeholder="$Amount" oninput="formatCurrency(this)" onblur="formatCurrencyComplete(this)" onchange="updateIncomeDisplay()">
                    </div>
                    <div class="form-group">
                        <label for="income1Frequency">Frequency:</label>
                        <select id="income1Frequency" onchange="updateIncomeDisplay()">
                            <option value="hourly">Hourly</option>
                            <option value="weekly">Weekly</option>
                            <option value="biweekly">Bi-weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly" selected>Yearly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="income1Hours">Hours/Week (if hourly):</label>
                        <input type="number" id="income1Hours" value="40" min="1" max="80" onchange="updateIncomeDisplay()">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3 id="partner2IncomeTitle">💰 Partner 2 Income - $0 per year</h3>
                <p style="color: #cccccc; margin-bottom: 15px; font-size: 0.9em;">Enter net "take-home" amounts after taxes and deductions</p>
                <div class="form-row-3">
                    <div class="form-group">
                        <label for="income2Rate">Net Take-Home Pay Rate ($):</label>
                        <input type="text" id="income2Rate" placeholder="$Amount" oninput="formatCurrency(this)" onblur="formatCurrencyComplete(this)" onchange="updateIncomeDisplay()">
                    </div>
                    <div class="form-group">
                        <label for="income2Frequency">Frequency:</label>
                        <select id="income2Frequency" onchange="updateIncomeDisplay()">
                            <option value="hourly">Hourly</option>
                            <option value="weekly">Weekly</option>
                            <option value="biweekly">Bi-weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly" selected>Yearly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="income2Hours">Hours/Week (if hourly):</label>
                        <input type="number" id="income2Hours" value="40" min="1" max="80" onchange="updateIncomeDisplay()">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>💼 Other Income Sources</h3>
                <p style="color: #cccccc; margin-bottom: 15px; font-size: 0.9em;">Add additional income sources beyond employment income</p>
                <div id="otherIncomeList">
                    <div class="income-item">
                        <select class="income-type" onchange="updateIncomeDisplay()">
                            <option value="rental">Rental Income</option>
                            <option value="investment">Investment Income</option>
                            <option value="vacation-rental">Vacation Rental</option>
                            <option value="royalties">Royalties</option>
                            <option value="pension">Pension Income</option>
                            <option value="social-benefits">Social Benefits</option>
                            <option value="freelance">Freelance/Contract</option>
                            <option value="side-business">Side Business</option>\n                            <option value="business-income">Business Income</option>
                            <option value="other">Other</option>
                        </select>
                        <input type="text" class="income-amount" placeholder="$0.00" oninput="formatCurrency(this)" onblur="formatCurrencyComplete(this)" onchange="updateIncomeDisplay()">
                        <input type="text" class="income-description" placeholder="Description (optional)">
                        <button type="button" class="remove-btn" onclick="removeIncomeSource(this)">Remove</button>
                    </div>
                </div>
                <button class="add-btn" onclick="addIncomeSource()">+ Add Income Source</button>
            </div>
        </div>
        
        <!-- Assumptions Tab -->
        <div id="assumptions" class="tab-content">
            <div class="form-section">
                <h3>📊 Financial Assumptions</h3>
                <div class="form-row-3">
                    <div class="form-group">
                        <label for="inflationRate">Inflation Rate (%):</label>
                        <input type="text" id="inflationRate" value="2.80%" oninput="formatPercentageValue(this, false)" onblur="formatPercentageValue(this, true)">
                        <small style="color: #cccccc;">Canadian historical average: 2.8%</small>
                    </div>
                    <div class="form-group">
                        <label for="preRetireRate">Pre-Retirement Investment Rate (%):</label>
                        <input type="text" id="preRetireRate" value="6.80%" oninput="formatPercentageValue(this, false)" onblur="formatPercentageValue(this, true)">
                    </div>
                    <div class="form-group">
                        <label for="postRetireRate">Post-Retirement Investment Rate (%):</label>
                        <input type="text" id="postRetireRate" value="4.80%" oninput="formatPercentageValue(this, false)" onblur="formatPercentageValue(this, true)">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="retirementIncomePercent">Retirement Income Needed (% of pre-retirement):</label>
                        <input type="text" id="retirementIncomePercent" value="70.00%" oninput="formatPercentageValue(this, false)" onblur="formatPercentageValue(this, true)">
                        <small style="color: #cccccc;">In Canada approximately 70% of pre-retirement income is needed for retired partners</small>
                    </div>
                    <div class="form-group">
                        <label for="widowReduction">Reduction for Widow(er) (%):</label>
                        <input type="text" id="widowReduction" value="70.00%" oninput="formatPercentageValue(this, false)" onblur="formatPercentageValue(this, true)">
                        <small style="color: #cccccc;">Reduced living expenses if one partner passes</small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="registeredTaxRate">Registered Account Tax Rate in Retirement (%):</label>
                        <input type="text" id="registeredTaxRate" value="28.50%" oninput="formatPercentageValue(this, false)" onblur="formatPercentageValue(this, true); updateBlendedTaxRate();">
                        <small style="color: #cccccc;">
                            Expected tax rate on RRSP/pension withdrawals<br>
                            <a href="https://www.canada.ca/en/revenue-agency/services/tax/individuals/frequently-asked-questions-individuals/canadian-income-tax-rates-individuals-current-previous-years.html" target="_blank" style="color: #c9a96e;">CRA Tax Brackets 2025</a> | Average retiree: 28.5% (combined federal/provincial)
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="blendedTaxRate">Blended Tax Rate (Registered + TFSA) (%):</label>
                        <input type="number" id="blendedTaxRate" step="0.01" value="14.25" min="0" max="40" readonly style="background: rgba(177, 151, 119, 0.1);">
                        <small style="color: #cccccc;">
                            Auto-calculated: 50% TFSA ($3,500/month max 2025) + 50% Registered
                            <div id="blendedRateCalculation" style="margin-top: 5px; font-size: 0.9em; color: #b19777;">
                                Calculation: (0% × 50%) + (28.5% × 50%) = 14.25%
                            </div>
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>🏠 Housing Assumptions</h3>
                <div class="form-row-3" style="grid-template-columns: 1fr 1fr 1.2fr;">
                    <div class="form-group">
                        <label for="currentHousing">Current Housing:</label>
                        <select id="currentHousing">
                            <option value="own">Own</option>
                            <option value="rent">Rent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="retirementHousing">Retirement Housing:</label>
                        <select id="retirementHousing" onchange="toggleRentField()">
                            <option value="own">Own</option>
                            <option value="rent">Rent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="downsizeIntent">Downsize at Retirement:</label>
                        <select id="downsizeIntent" onchange="toggleDownsizeField()">
                            <option value="no">No</option>
                            <option value="yes">Yes</option>
                        </select>
                    </div>
                </div>
                
                <!-- Conditional fields displayed separately when needed -->
                <div class="form-row" id="downsizeValueGroup" style="display: none;">
                    <div class="form-group">
                        <label for="downsizeValue">Downsize Value in Today's Dollars ($):</label>
                        <input type="text" id="downsizeValue" value="$0.00" oninput="formatCurrency(this)" onblur="formatCurrencyComplete(this)" placeholder="Expected proceeds from downsizing">
                        <small style="color: #cccccc;">Net proceeds after selling current home and buying smaller one</small>
                    </div>
                </div>
                
                <div class="form-row" id="retirementRentGroup" style="display: none;">
                    <div class="form-group">
                        <label for="retirementRent">Expected Monthly Rent in Retirement ($):</label>
                        <input type="text" id="retirementRent" value="$2,200.00" oninput="formatCurrency(this)" onblur="formatCurrencyComplete(this)">
                        <small style="color: #cccccc;">Calgary, AB average: $2,200</small>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>🏛️ CPP/OAS Estimates</h3>
                <div class="form-row-4">
                    <div class="form-group">
                        <label for="cpp1Monthly" id="cpp1Label">Partner 1 CPP Monthly ($):</label>
                        <input type="text" id="cpp1Monthly" value="$758.00" oninput="formatCurrency(this)" onblur="formatCurrencyComplete(this)">
                        <small style="color: #cccccc;">2024 average: $758</small>
                    </div>
                    <div class="form-group">
                        <label for="oas1Monthly" id="oas1Label">Partner 1 OAS Monthly ($):</label>
                        <input type="text" id="oas1Monthly" value="$713.00" oninput="formatCurrency(this)" onblur="formatCurrencyComplete(this)">
                        <small style="color: #cccccc;">2024 maximum: $713</small>
                    </div>
                    <div class="form-group">
                        <label for="cpp2Monthly" id="cpp2Label">Partner 2 CPP Monthly ($):</label>
                        <input type="text" id="cpp2Monthly" value="$758.00" oninput="formatCurrency(this)" onblur="formatCurrencyComplete(this)">
                        <small style="color: #cccccc;">2024 average: $758</small>
                    </div>
                    <div class="form-group">
                        <label for="oas2Monthly" id="oas2Label">Partner 2 OAS Monthly ($):</label>
                        <input type="text" id="oas2Monthly" value="$713.00" oninput="formatCurrency(this)" onblur="formatCurrencyComplete(this)">
                        <small style="color: #cccccc;">2024 average: $713</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Goals Tab -->
        <div id="goals" class="tab-content">
            <div class="form-section">
                <h3>🎯 Financial Goals</h3>
                <p style="color: #cccccc; margin-bottom: 15px; font-size: 0.9em;">Enter goals with amounts to include them in calculations automatically</p>
                <div id="goalsList">
                    <div class="goal-item" style="display: grid; grid-template-columns: 1.5fr 1.5fr 0.7fr 1fr 0.8fr 0.3fr; gap: 8px; align-items: center;">
                        <select class="goal-type">
                            <option value="home">Home Purchase</option>
                            <option value="mortgage">Pay Off Mortgage</option>
                            <option value="education">Education Funding</option>
                            <option value="business">Start Business</option>
                            <option value="travel">Travel</option>
                            <option value="debt">Pay Off Debts</option>
                            <option value="parents">Aging Parents Support</option>
                            <option value="emergency">Emergency Fund</option>
                            <option value="other">Other</option>
                        </select>
                        <input type="text" class="goal-description" placeholder="Description (e.g., Mexico Trip)" maxlength="50">
                        <input type="number" class="goal-years" placeholder="Years Away" min="0" max="50">
                        <input type="text" class="goal-amount" placeholder="$0.00" oninput="formatCurrency(this)" onblur="formatCurrencyComplete(this)">
                        <select class="goal-frequency">
                            <option value="one-time">One-time</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                        <button class="remove-btn" onclick="removeGoal(this)" title="Remove this goal">×</button>
                    </div>
                </div>
                <button class="add-btn" onclick="addGoal()">+ Add Goal</button>
            </div>
            
            <div class="form-section">
                <h3>🌟 Life & Financial Priorities</h3>
                <p style="color: #cccccc; margin-bottom: 20px;">Select the priorities that are important to you and your family:</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="checkbox-group">
                        <input type="checkbox" id="goal-travel-more" class="priority-goal">
                        <label for="goal-travel-more" style="margin-bottom: 0;">Travel More</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="goal-inflation" class="priority-goal">
                        <label for="goal-inflation" style="margin-bottom: 0;">Keep ahead of inflation</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="goal-invest" class="priority-goal">
                        <label for="goal-invest" style="margin-bottom: 0;">Learn to invest wisely</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="goal-estate" class="priority-goal">
                        <label for="goal-estate" style="margin-bottom: 0;">Leave an estate for my family</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="goal-coach" class="priority-goal">
                        <label for="goal-coach" style="margin-bottom: 0;">Acquire a financial coach</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="goal-retirement-plan" class="priority-goal">
                        <label for="goal-retirement-plan" style="margin-bottom: 0;">Create a solid plan for retirement</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="goal-family" class="priority-goal">
                        <label for="goal-family" style="margin-bottom: 0;">Start a family</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="goal-funeral" class="priority-goal">
                        <label for="goal-funeral" style="margin-bottom: 0;">Funeral planning & concierge</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="goal-insurance" class="priority-goal">
                        <label for="goal-insurance" style="margin-bottom: 0;">Save money on home/auto/pet insurance</label>
                    </div>
                </div>
            </div>
        </div>
        
        
        <!-- Assets Tab -->
        <div id="assets" class="tab-content">
            <!-- Liquid Assets Section -->
            <div class="form-section">
                <h3>💧 Liquid Assets <span style="font-size: 0.8em; color: #cccccc; font-weight: normal;">- Easily convertible to cash</span></h3>
                <p style="color: #cccccc; margin-bottom: 15px; font-size: 0.9em;">Savings, investments, and retirement accounts that can be readily accessed</p>
                
                <!-- Column Headers -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 0.6fr 1fr; gap: 12px; margin-bottom: 10px; padding: 10px 15px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; font-weight: 600; color: #b19777;">
                    <div>Asset Type</div>
                    <div>Current Value ($)</div>
                    <div>Rate of Return (%)</div>
                    <div>Institution and Notes</div>
                </div>
                <div id="liquidAssetsList">
                    <div class="asset-item liquid-asset" style="display: grid; grid-template-columns: 1.5fr 1fr 0.7fr 1.5fr 0.3fr; gap: 8px; align-items: center;">
                        <select class="asset-type">
                            <option value="rrsp">RRSP</option>
                            <option value="tfsa">TFSA</option>
                            <option value="non-registered">Non-Registered Investments</option>
                            <option value="savings">High-Interest Savings</option>
                            <option value="pension">Pension Plan</option>
                            <option value="rdsp">RDSP</option>
                            <option value="resp">RESP</option>
                            <option value="stocks">Stocks/ETFs</option>
                            <option value="bonds">Bonds/GICs</option>
                            <option value="crypto">Cryptocurrency</option>
                            <option value="other-liquid">Other Liquid</option>
                        </select>
                        <input type="text" class="asset-value" placeholder="$0.00" step="1000" value="$0.00" onchange="formatCurrency(this)">
                        <input type="text" class="asset-growth" placeholder="1.00%" step="0.01" value="1.00%" oninput="formatPercentageValue(this, false)" onblur="formatPercentageValue(this, true)">
                        <input type="text" class="asset-notes" placeholder="Institution and Notes">
                        <button class="remove-btn" onclick="removeLiquidAsset(this)" title="Remove this asset">×</button>
                    </div>
                </div>
                <button class="add-btn" onclick="addLiquidAsset()">+ Add Liquid Asset</button>
            </div>

            <!-- Fixed Assets Section -->
            <div class="form-section">
                <h3>🏠 Fixed Assets <span style="font-size: 0.8em; color: #cccccc; font-weight: normal;">- Tangible, long-term investments</span></h3>
                <p style="color: #cccccc; margin-bottom: 15px; font-size: 0.9em;">Real estate, business interests, and physical assets that take time to convert to cash</p>
                
                <!-- Column Headers -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 0.6fr 1fr; gap: 12px; margin-bottom: 10px; padding: 10px 15px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; font-weight: 600; color: #b19777;">
                    <div>Asset Type</div>
                    <div>Current Value ($)</div>
                    <div>Rate of Return (%)</div>
                    <div>Location and Notes</div>
                </div>
                <div id="fixedAssetsList">
                    <div class="asset-item fixed-asset" style="display: grid; grid-template-columns: 1.5fr 1fr 0.7fr 1.5fr 0.3fr; gap: 8px; align-items: center;">
                        <select class="asset-type">
                            <option value="primary-residence">Primary Residence</option>
                            <option value="rental-property">Rental Property</option>
                            <option value="vacation-property">Vacation Property</option>
                            <option value="commercial-real-estate">Commercial Real Estate</option>
                            <option value="business-ownership">Business Ownership</option>
                            <option value="vehicles">Vehicles</option>
                            <option value="precious-metals">Precious Metals</option>
                            <option value="collectibles">Collectibles/Art</option>
                            <option value="intellectual-property">Intellectual Property</option>
                            <option value="other-fixed">Other Fixed</option>
                        </select>
                        <input type="text" class="asset-value" placeholder="$0.00" step="1000" value="$0.00" onchange="formatCurrency(this)">
                        <input type="text" class="asset-growth" placeholder="3.00%" step="0.01" value="3.00%" oninput="formatPercentageValue(this, false)" onblur="formatPercentageValue(this, true)">
                        <input type="text" class="asset-notes" placeholder="Location and Notes">
                        <button class="remove-btn" onclick="removeFixedAsset(this)" title="Remove this asset">×</button>
                    </div>
                </div>
                <button class="add-btn" onclick="addFixedAsset()">+ Add Fixed Asset</button>
            </div>
        </div>
        
        <!-- Liabilities Tab -->
        <div id="liabilities" class="tab-content">
            <!-- Mortgages Section -->
            <div class="form-section">
                <h3>🏠 Mortgages <span style="font-size: 0.8em; color: #cccccc; font-weight: normal;">- Primary residence, rental properties, etc.</span></h3>
                <p style="color: #cccccc; margin-bottom: 15px; font-size: 0.9em;">Detailed mortgage information with automatic payment calculations</p>
                
                <!-- Mortgage Column Headers -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 0.8fr 0.8fr 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; padding: 8px 12px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; font-weight: 600; color: #b19777; font-size: 0.85em;">
                    <div>Property</div>
                    <div>Original Amount</div>
                    <div>Balance</div>
                    <div>Rate (%)</div>
                    <div>Amortization Years</div>
                    <div>Monthly Payment</div>
                    <div>Maturity Date</div>
                </div>
                <div id="mortgagesList">
                    <div class="mortgage-item" style="display: grid; grid-template-columns: 1fr 1fr 1fr 0.6fr 0.8fr 1fr 1fr 0.3fr; gap: 8px; align-items: center;">
                        <select class="mortgage-property">
                            <option value="primary">Primary Residence</option>
                            <option value="rental">Rental Property</option>
                            <option value="vacation">Vacation Home</option>
                            <option value="commercial">Commercial Property</option>
                            <option value="other">Other Property</option>
                        </select>
                        <input type="text" class="mortgage-original" placeholder="$0.00" onchange="formatCurrency(this); calculateMortgagePayment(this)">
                        <input type="text" class="mortgage-balance" placeholder="$0.00" onchange="formatCurrency(this); calculateMortgagePayment(this)">
                        <input type="number" class="mortgage-rate" placeholder="5.00" step="0.01" onchange="calculateMortgagePayment(this)">
                        <input type="number" class="mortgage-term" placeholder="25" step="1" onchange="calculateMortgagePayment(this)">
                        <input type="text" class="mortgage-payment" placeholder="$0.00" readonly style="background: rgba(177, 151, 119, 0.1);">
                        <input type="month" class="mortgage-maturity" onchange="calculateMortgagePayment(this)">
                        <button class="remove-btn" onclick="removeMortgage(this)" title="Remove this mortgage">×</button>
                    </div>
                </div>
                <button class="add-btn" onclick="addMortgage()">+ Add Mortgage</button>
            </div>

            <!-- Secured Debts Section -->
            <div class="form-section">
                <h3>🔐 Secured Debts <span style="font-size: 0.8em; color: #cccccc; font-weight: normal;">- Asset-backed loans</span></h3>
                <p style="color: #cccccc; margin-bottom: 15px; font-size: 0.9em;">Loans backed by collateral such as vehicles, equipment, or other assets</p>
                
                <!-- Secured Debt Column Headers -->
                <div style="display: grid; grid-template-columns: 1.2fr 0.7fr 0.4fr 0.7fr 60px; gap: 6px; margin-bottom: 10px; padding: 10px 15px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; font-weight: 600; color: #b19777;">
                    <div>Debt Type</div>
                    <div>Current Balance ($)</div>
                    <div>Interest Rate (%)</div>
                    <div>Monthly Payment ($)</div>
                    <div></div>
                </div>
                <div id="securedDebtsList">
                    <div class="liability-item secured-debt" style="display: grid; grid-template-columns: 1.2fr 0.7fr 0.4fr 0.7fr 60px; gap: 6px; align-items: center;">
                        <select class="liability-type">
                            <option value="vehicle">Home Equity Line of Credit (HELOC)</option>
                            <option value="vehicle">Vehicle Loan</option>
                            <option value="vehicle-lease">Vehicle Lease</option>
                            <option value="boat">Boat/RV Loan</option>
                            <option value="equipment">Equipment Loan</option>
                            <option value="secured-loan">Secured Personal Loan</option>
                            <option value="other-secured">Other Secured</option>
                        </select>
                        <input type="text" class="liability-balance" placeholder="$0.00" onchange="formatCurrency(this)">
                        <div style="position: relative;">
                            <input type="number" class="liability-rate" placeholder="8.00" step="0.1" style="width: 100%; padding-right: 25px;">
                            <span class="percentage-symbol" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #b19777;">%</span>
                        </div>
                        <input type="text" class="liability-payment" placeholder="$0.00" onchange="formatCurrency(this)">
                        <button class="remove-btn" onclick="removeDebtItem(this)" title="Remove this debt">×</button>
                    </div>
                </div>
                <button class="add-btn" onclick="addSecuredDebt()">+ Add Secured Debt</button>
            </div>

            <!-- Unsecured Debts Section -->
            <div class="form-section">
                <h3>💳 Unsecured Debts <span style="font-size: 0.8em; color: #cccccc; font-weight: normal;">- Credit cards, personal loans</span></h3>
                <p style="color: #cccccc; margin-bottom: 15px; font-size: 0.9em;">Debts not backed by collateral, typically with higher interest rates</p>
                
                <!-- Unsecured Debt Column Headers -->
                <div style="display: grid; grid-template-columns: 1.2fr 0.7fr 0.4fr 0.7fr 60px; gap: 6px; margin-bottom: 10px; padding: 10px 15px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; font-weight: 600; color: #b19777;">
                    <div>Debt Type</div>
                    <div>Current Balance ($)</div>
                    <div>Interest Rate (%)</div>
                    <div>Monthly Payment ($)</div>
                    <div></div>
                </div>
                <div id="unsecuredDebtsList">
                    <div class="liability-item unsecured-debt" style="display: grid; grid-template-columns: 1.2fr 0.7fr 0.4fr 0.7fr 60px; gap: 6px; align-items: center;">
                        <select class="liability-type">
                            <option value="credit-card">Credit Card</option>
                            <option value="line-of-credit">Line of Credit</option>
                            <option value="personal-loan">Personal Loan</option>
                            <option value="student-loan">Student Loan</option>
                            <option value="payday-loan">Payday Loan</option>
                            <option value="other-unsecured">Other Unsecured</option>
                        </select>
                        <input type="text" class="liability-balance" placeholder="$0.00" onchange="formatCurrency(this)">
                        <div style="position: relative;">
                            <input type="number" class="liability-rate" placeholder="19.00" step="0.1" style="width: 100%; padding-right: 25px;">
                            <span class="percentage-symbol" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #b19777;">%</span>
                        </div>
                        <input type="text" class="liability-payment" placeholder="$0.00" onchange="formatCurrency(this)">
                        <button class="remove-btn" onclick="removeDebtItem(this)" title="Remove this debt">×</button>
                    </div>
                </div>
                <button class="add-btn" onclick="addUnsecuredDebt()">+ Add Unsecured Debt</button>
            </div>
        </div>
        
        <!-- Insurance Tab -->
        <div id="insurance" class="tab-content">
            <div class="form-section">
                <h3>🛡️ Current Insurance Policies</h3>
                <div id="insuranceList">
                    <div class="insurance-item" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 0.3fr; gap: 8px; align-items: center;">
                        <div class="form-group">
                            <label>Policy Type:</label>
                            <select class="insurance-type" onchange="updateInsuranceTerm(this)">
                                <option value="term-life">Term Life</option>
                                <option value="whole-life">Whole Life</option>
                                <option value="universal-life">Universal Life</option>
                                <option value="disability">Employee Benefits Life Insurance</option>
                                <option value="disability">Disability</option>
                                <option value="critical-illness">Critical Illness</option>
                                <option value="health">Health/Extended Health</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Insurance Company:</label>
                            <input type="text" class="insurance-company" placeholder="e.g., Manulife, Sun Life">
                        </div>
                        <div class="form-group">
                            <label>Coverage Amount ($):</label>
                            <input type="text" class="insurance-amount" step="10000" placeholder="$0.00" onchange="handleInsuranceChange(this)">
                        </div>
                        <div class="form-group">
                            <label>Monthly Premium ($):</label>
                            <input type="text" class="insurance-premium" step="10" placeholder="$0.00" onchange="handleInsuranceChange(this)">
                        </div>
                        <div class="form-group">
                            <label>Term/Duration:</label>
                            <input type="text" class="insurance-term" placeholder="e.g., 20 years, Age 65">
                        </div>
                        <div class="form-group">
                            <label>Expiry Date:</label>
                            <input type="month" class="insurance-expiry" placeholder="MM/YYYY">
                        </div>
                        <div class="form-group">
                            <label>Policy Owner:</label>
                            <select class="insurance-owner">
                                <option value="self">Self</option>
                                <option value="spouse">Spouse</option>
                                <option value="joint">Joint</option>
                                <option value="trust">Trust</option>
                                <option value="business">Business</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Primary Beneficiary:</label>
                            <input type="text" class="insurance-beneficiary" placeholder="Name or relationship">
                        </div>
                        <button class="remove-btn" onclick="removeInsurancePolicy(this)" title="Remove this insurance policy">×</button>
                    </div>
                </div>
                <button class="add-btn" onclick="addInsurance()">+ Add Insurance Policy</button>
            </div>
            
            <!-- Partner 1 DIME Analysis -->
            <div class="form-section">
                <h3 id="partner1DimeTitle">💰 Partner 1 Insurance Needs Analysis (DIME Method)</h3>
                <p style="color: #cccccc; margin-bottom: 15px; font-size: 0.9em;">Calculate insurance needed if Partner 1 passes away first</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="finalExpenses1">Final Expenses ($):</label>
                        <input type="text" id="finalExpenses1" value="$15,000.00" step="1000" onchange="formatCurrency(this); updateDimeCalculations()">
                        <small style="color: #cccccc;">Funeral, legal, medical costs</small>
                    </div>
                    <div class="form-group">
                        <label for="incomeReplacement1">Years of Income Replacement:</label>
                        <input type="number" id="incomeReplacement1" value="10" min="1" max="30" onchange="updateDimeCalculations()">
                        <small id="incomeReplacementLabel1" style="color: #cccccc;">Years to replace Partner 1's income</small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="mortgageDebt1">Mortgage/Debt to Pay Off ($):</label>
                        <input type="text" id="mortgageDebt1" step="10000" placeholder="Auto-calculated" readonly style="background: rgba(177, 151, 119, 0.1);">
                        <small style="color: #cccccc;">Will be calculated from your liabilities</small>
                    </div>
                    <div class="form-group">
                        <label for="educationFund1">Education Fund Needed ($):</label>
                        <input type="text" id="educationFund1" step="5000" placeholder="Auto-calculated" readonly style="background: rgba(177, 151, 119, 0.1);">
                        <small style="color: #cccccc;">Will be calculated from your dependents</small>
                    </div>
                </div>
                
                <!-- Auto-calculating DIME Analysis -->
                <div id="partner1DimeResults" class="results-section" style="margin-top: 25px;">
                    <div id="partner1DimeTotal" style="text-align: center; margin: 20px 0;">
                        <div id="partner1TotalDisplay" style="font-size: 2.5em; font-weight: bold; color: #ffffff; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">$20,000</div>
                        <div style="color: #b19777; margin-top: 5px; font-size: 1.1em;">Total Insurance Needed (Rounded to nearest $10k)</div>
                    </div>
                    <h4>Partner 1 Insurance Coverage Analysis</h4>
                    <div id="partner1DimeTable" style="margin: 20px 0;">
                        <!-- Partner 1 DIME calculation table will be populated by JavaScript -->
                    </div>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div id="partner1TotalNeed" class="value">$0</div>
                            <div class="label">Total Insurance Needed</div>
                        </div>
                        <div class="summary-card">
                            <div id="partner1CurrentCoverage" class="value">$0</div>
                            <div class="label">Current Coverage</div>
                        </div>
                        <div class="summary-card">
                            <div id="partner1Gap" class="value">$0</div>
                            <div class="label">Coverage Gap</div>
                        </div>
                        <div class="summary-card">
                            <div id="partner1Premiums" class="value">$0</div>
                            <div class="label">Monthly Premiums</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Partner 2 DIME Analysis -->
            <div class="form-section">
                <h3 id="partner2DimeTitle">💰 Partner 2 Insurance Needs Analysis (DIME Method)</h3>
                <p style="color: #cccccc; margin-bottom: 15px; font-size: 0.9em;">Calculate insurance needed if Partner 2 passes away first</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="finalExpenses2">Final Expenses ($):</label>
                        <input type="text" id="finalExpenses2" value="$15,000.00" oninput="formatCurrency(this)" onblur="formatCurrencyComplete(this)" onchange="updateDimeCalculations()">
                        <small style="color: #cccccc;">Funeral, legal, medical costs</small>
                    </div>
                    <div class="form-group">
                        <label for="incomeReplacement2">Years of Income Replacement:</label>
                        <input type="number" id="incomeReplacement2" value="10" min="1" max="30" onchange="updateDimeCalculations()">
                        <small id="incomeReplacementLabel2" style="color: #cccccc;">Years to replace Partner 2's income</small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="mortgageDebt2">Mortgage/Debt to Pay Off ($):</label>
                        <input type="text" id="mortgageDebt2" step="10000" placeholder="Auto-calculated" readonly style="background: rgba(177, 151, 119, 0.1);">
                        <small style="color: #cccccc;">Will be calculated from your liabilities</small>
                    </div>
                    <div class="form-group">
                        <label for="educationFund2">Education Fund Needed ($):</label>
                        <input type="text" id="educationFund2" step="5000" placeholder="Auto-calculated" readonly style="background: rgba(177, 151, 119, 0.1);">
                        <small style="color: #cccccc;">Will be calculated from your dependents</small>
                    </div>
                </div>
                
                <!-- Auto-calculating DIME Analysis -->
                <div id="partner2DimeResults" class="results-section" style="margin-top: 25px;">
                    <div id="partner2DimeTotal" style="text-align: center; margin: 20px 0;">
                        <div id="partner2TotalDisplay" style="font-size: 2.5em; font-weight: bold; color: #ffffff; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">$20,000</div>
                        <div style="color: #b19777; margin-top: 5px; font-size: 1.1em;">Total Insurance Needed (Rounded to nearest $10k)</div>
                    </div>
                    <h4>Partner 2 Insurance Coverage Analysis</h4>
                    <div id="partner2DimeTable" style="margin: 20px 0;">
                        <!-- Partner 2 DIME calculation table will be populated by JavaScript -->
                    </div>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div id="partner2TotalNeed" class="value">$0</div>
                            <div class="label">Total Insurance Needed</div>
                        </div>
                        <div class="summary-card">
                            <div id="partner2CurrentCoverage" class="value">$0</div>
                            <div class="label">Current Coverage</div>
                        </div>
                        <div class="summary-card">
                            <div id="partner2Gap" class="value">$0</div>
                            <div class="label">Coverage Gap</div>
                        </div>
                        <div class="summary-card">
                            <div id="partner2Premiums" class="value">$0</div>
                            <div class="label">Monthly Premiums</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- DIME Analysis Charts -->
            <div class="form-section" style="margin-top: 40px;">
                <h3>📊 DIME Analysis Over Time</h3>
                <p style="color: #cccccc; margin-bottom: 25px;">Insurance needs projection showing optimal term insurance coverage periods</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div class="chart-container">
                        <h4 style="color: #b19777; text-align: center; margin-bottom: 15px;" id="partner1DimeChartTitle">Partner 1 DIME Analysis</h4>
                        <canvas id="partner1DimeChart" width="400" height="300"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4 style="color: #b19777; text-align: center; margin-bottom: 15px;" id="partner2DimeChartTitle">Partner 2 DIME Analysis</h4>
                        <canvas id="partner2DimeChart" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <!-- Term Insurance Legend -->
                <div style="background: #444; border: 1px solid #666; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h5 style="color: #b19777; margin-bottom: 15px;">Term Insurance Coverage Options</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; color: #cccccc;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 20px; height: 3px; background: #e74c3c;"></div>
                            <span>10-Year Term</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 20px; height: 3px; background: #f39c12;"></div>
                            <span>20-Year Term</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 20px; height: 3px; background: #3498db;"></div>
                            <span>30-Year Term</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 20px; height: 3px; background: #27ae60;"></div>
                            <span>To Age 100</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Tab -->
        <div id="results" class="tab-content">
            <button class="calculate-btn" onclick="calculateFinancialNeedsAnalysis()">🧮 Calculate Financial Needs Analysis</button>
            
            <div id="calculationResults">
                <div class="fin-display">
                    <h2>Your Financial Independence Numbers (FIN#)</h2>
                    <p style="color: #cccccc; margin-bottom: 25px;">Total amount needed at retirement based on tax strategy and drawdown approach</p>
                    
                    <!-- 3x3 FIN Matrix -->
                    <div class="fin-matrix">
                        <div class="matrix-header">
                            <div class="matrix-corner"></div>
                            <div class="tax-header">Registered Accounts<br><small>RRSP, Pension (25% tax)</small></div>
                            <div class="tax-header">Blended Strategy<br><small>RRSP + TFSA (15% tax)</small></div>
                            <div class="tax-header">Non-Taxable<br><small>TFSA, Insurance (0% tax)</small></div>
                        </div>
                        
                        <div class="matrix-row">
                            <div class="scenario-header">
                                <strong>Principal Maintenance</strong><br>
                                <small>Portfolio never depletes</small>
                            </div>
                            <div class="fin-cell" id="fin-registered-preserve">
                                <div class="fin-amount">$0</div>
                                <div class="monthly-amount">$0/month</div>
                            </div>
                            <div class="fin-cell" id="fin-blended-preserve">
                                <div class="fin-amount">$0</div>
                                <div class="monthly-amount">$0/month</div>
                            </div>
                            <div class="fin-cell" id="fin-nontax-preserve">
                                <div class="fin-amount">$0</div>
                                <div class="monthly-amount">$0/month</div>
                            </div>
                        </div>
                        
                        <div class="matrix-row">
                            <div class="scenario-header">
                                <strong>Drawdown + 10 Years</strong><br>
                                <small>Portfolio lasts to life expectancy + 10</small>
                            </div>
                            <div class="fin-cell" id="fin-registered-buffer">
                                <div class="fin-amount">$0</div>
                                <div class="monthly-amount">$0/month</div>
                            </div>
                            <div class="fin-cell" id="fin-blended-buffer">
                                <div class="fin-amount">$0</div>
                                <div class="monthly-amount">$0/month</div>
                            </div>
                            <div class="fin-cell" id="fin-nontax-buffer">
                                <div class="fin-amount">$0</div>
                                <div class="monthly-amount">$0/month</div>
                            </div>
                        </div>
                        
                        <div class="matrix-row">
                            <div class="scenario-header">
                                <strong>Drawdown to Lifespan</strong><br>
                                <small>Portfolio depletes at life expectancy</small>
                            </div>
                            <div class="fin-cell" id="fin-registered-deplete">
                                <div class="fin-amount">$0</div>
                                <div class="monthly-amount">$0/month</div>
                            </div>
                            <div class="fin-cell" id="fin-blended-deplete">
                                <div class="fin-amount">$0</div>
                                <div class="monthly-amount">$0/month</div>
                            </div>
                            <div class="fin-cell" id="fin-nontax-deplete">
                                <div class="fin-amount">$0</div>
                                <div class="monthly-amount">$0/month</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="scenarioResults">
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div id="yearsToRetirement" class="value">0</div>
                            <div class="label">Years to Retirement</div>
                        </div>
                        <div class="summary-card">
                            <div id="retirementLength" class="value">0</div>
                            <div class="label">Years in Retirement</div>
                        </div>
                        <div class="summary-card">
                            <div id="monthlyShortfall" class="value">$0</div>
                            <div class="label">Monthly Income Shortfall</div>
                        </div>
                        <div class="summary-card">
                            <div id="monthlySavingsNeeded" class="value">$0</div>
                            <div class="label">Monthly Savings Needed</div>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="projectionChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="netWorthChart"></canvas>
                </div>
                
                <div class="form-section">
                    <h3>📊 Detailed Breakdown</h3>
                    <div id="detailedBreakdown"></div>
                </div>
                
                <!-- Financial Analysis Charts -->
                <div class="charts-section" style="margin-top: 40px;">
                    <h3 style="color: #b19777; text-align: center; margin-bottom: 30px; font-size: 1.8em;">📊 Financial Analysis Overview</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                        <div class="chart-container">
                            <h4 style="color: #b19777; text-align: center; margin-bottom: 15px;">Net Worth Breakdown</h4>
                            <canvas id="netWorthChart" width="400" height="300"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4 style="color: #b19777; text-align: center; margin-bottom: 15px;">Monthly Cash Flow</h4>
                            <canvas id="cashFlowChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                        <div class="chart-container">
                            <h4 style="color: #b19777; text-align: center; margin-bottom: 15px;">Insurance Coverage Analysis</h4>
                            <canvas id="insuranceChart" width="400" height="300"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4 style="color: #b19777; text-align: center; margin-bottom: 15px;">Retirement Projection</h4>
                            <canvas id="retirementChart" width="400" height="400"></canvas>
                        </div>
                    </div>
                </div>
                
                <button class="print-btn" onclick="generatePrintSummary()">🖨️ Generate Printable Summary</button>
            </div>
        </div>
    </div>
    
    <!-- Hidden print summary -->
    <div id="printSummary" class="print-summary hidden">
        <!-- Print content will be generated here -->
    </div>
    
    <script>
        // Global function - defined immediately
        function switchTab(tabName) {
            console.log('switchTab called with:', tabName);
            
            // Hide all tab content
            var contents = document.getElementsByClassName('tab-content');
            for (var i = 0; i < contents.length; i++) {
                contents[i].classList.remove('active');
            }
            
            // Remove active from all tabs
            var tabs = document.getElementsByClassName('tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // Show selected content
            var selectedContent = document.getElementById(tabName);
            if (selectedContent) {
                selectedContent.classList.add('active');
            }
            
            // Activate clicked tab
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Auto-calculate income replacement when switching to insurance tab
            if (tabName === 'insurance') {
                calculateIncomeReplacementYears();
                // Update DIME calculations for both partners to refresh monthly premiums
                calculateDimeAnalysis('partner1');
                calculateDimeAnalysis('partner2');
                // Create DIME charts
                setTimeout(() => createDimeCharts(), 100); // Small delay to ensure DOM is ready
            }
        }
        
        // Real-time currency formatting function
        function formatCurrency(input) {
            let value = input.value;
            
            // Remove everything except digits and decimal point
            value = value.replace(/[^\d.]/g, '');
            
            // Handle multiple decimal points
            let parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // Don't format while user is typing if it's incomplete
            if (value === '' || value === '.') {
                return;
            }
            
            // Parse and format
            let num = parseFloat(value);
            if (!isNaN(num)) {
                // Format with commas but preserve what user is typing
                let formatted = num.toLocaleString('en-US');
                input.value = '$' + formatted;
            }
        }
        
        // Format currency on blur (complete formatting)
        function formatCurrencyComplete(input) {
            let value = input.value.replace(/[^\d.]/g, '');
            if (value === '') {
                input.value = '$0.00';
                return;
            }
            
            let num = parseFloat(value);
            if (!isNaN(num)) {
                input.value = '$' + num.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        }
        
        // Handle insurance field changes - format currency and update DIME calculations
        function handleInsuranceChange(input) {
            formatCurrency(input);
            // Trigger DIME calculations for both partners to update monthly premiums
            calculateDimeAnalysis('partner1');
            calculateDimeAnalysis('partner2');
        }
        
        // Global functions for adding form elements
        // Add new dependent row with exact same grid layout as original
        function addDependent() {
            const container = document.getElementById('dependentsList');
            const div = document.createElement('div');
            div.className = 'dependent-item';
            div.style.display = 'grid';
            div.style.gridTemplateColumns = '1fr 1fr 1fr 1fr 1fr 0.3fr';
            div.style.gap = '8px';
            div.style.alignItems = 'center';
            div.innerHTML = `
                <div class="form-group">
                    <label>Child Name:</label>
                    <input type="text" class="dependent-name" placeholder="Child's Name">
                </div>
                <div class="form-group">
                    <label>Date of Birth:</label>
                    <input type="text" class="dependent-dob" placeholder="YYYYMMDD" oninput="formatDateInput(this)">
                </div>
                <div class="form-group">
                    <label>Post-Secondary Start Age:</label>
                    <input type="number" class="dependent-edu-age" value="18" min="16" max="25">
                </div>
                <div class="form-group">
                    <label>Years of Study:</label>
                    <input type="number" class="dependent-study-years" value="4" min="1" max="8">
                </div>
                <div class="form-group">
                    <label>Annual Education Cost:</label>
                    <input type="text" class="dependent-edu-cost" value="$12,000.00" oninput="formatCurrency(this)" onblur="formatCurrencyComplete(this)">
                </div>
                <button class="remove-btn" onclick="removeDependent(this)" title="Remove this dependent">×</button>
            `;
            container.appendChild(div);
        }
        
        function removeDependent(button) {
            const dependentItem = button.closest('.dependent-item');
            if (dependentItem) {
                dependentItem.remove();
            }
        }
        
        function addGoal() {
            const container = document.getElementById('goalsList');
            const div = document.createElement('div');
            div.className = 'goal-item';
            div.style.display = 'grid';
            div.style.gridTemplateColumns = '1.5fr 1.5fr 0.7fr 1fr 0.8fr 0.3fr';
            div.style.gap = '8px';
            div.style.alignItems = 'center';
            div.innerHTML = `
                <select class="goal-type">
                    <option value="home">Home Purchase</option>
                    <option value="mortgage">Pay Off Mortgage</option>
                    <option value="education">Education Funding</option>
                    <option value="business">Start Business</option>
                    <option value="travel">Travel</option>
                    <option value="debt">Pay Off Debts</option>
                    <option value="parents">Aging Parents Support</option>
                    <option value="emergency">Emergency Fund</option>
                    <option value="other">Other</option>
                </select>
                <input type="text" class="goal-description" placeholder="Description (e.g., Mexico Trip)" maxlength="50">
                <input type="number" class="goal-years" placeholder="Years Away" min="0" max="50">
                <input type="text" class="goal-amount" placeholder="$0.00" oninput="formatCurrency(this)" onblur="formatCurrencyComplete(this)">
                <select class="goal-frequency">
                    <option value="one-time">One-time</option>
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                </select>
                <button class="remove-btn" onclick="removeGoal(this)" title="Remove this goal">×</button>
            `;
            container.appendChild(div);
        }
        
        function removeGoal(button) {
            const goalItem = button.closest('.goal-item');
            if (goalItem) {
                goalItem.remove();
            }
        }
        
        function addLiquidAsset() {
            const container = document.getElementById('liquidAssetsList');
            const div = document.createElement('div');
            div.className = 'asset-item liquid-asset';
            div.style.display = 'grid';
            div.style.gridTemplateColumns = '1.5fr 1fr 0.7fr 1.5fr 0.3fr';
            div.style.gap = '8px';
            div.style.alignItems = 'center';
            div.innerHTML = `
                <select class="asset-type">
                    <option value="rrsp">RRSP</option>
                    <option value="tfsa">TFSA</option>
                    <option value="non-registered">Non-Registered Investments</option>
                    <option value="savings">High-Interest Savings</option>
                    <option value="pension">Pension Plan</option>
                    <option value="rdsp">RDSP</option>
                    <option value="resp">RESP</option>
                    <option value="stocks">Stocks/ETFs</option>
                    <option value="bonds">Bonds/GICs</option>
                    <option value="crypto">Cryptocurrency</option>
                    <option value="other-liquid">Other Liquid</option>
                </select>
                <input type="text" class="asset-value" placeholder="$0.00" value="$0.00" onchange="formatCurrency(this)">
                <input type="text" class="asset-growth" placeholder="1.00%" value="1.00%" oninput="formatPercentageValue(this, false)" onblur="formatPercentageValue(this, true)">
                <input type="text" class="asset-notes" placeholder="Institution and Notes">
                <button class="remove-btn" onclick="removeLiquidAsset(this)" title="Remove this asset">×</button>
            `;
            container.appendChild(div);
        }
        
        function removeLiquidAsset(button) {
            const assetItem = button.closest('.asset-item');
            if (assetItem) {
                assetItem.remove();
            }
        }
        
        function addFixedAsset() {
            const container = document.getElementById('fixedAssetsList');
            const div = document.createElement('div');
            div.className = 'asset-item fixed-asset';
            div.style.display = 'grid';
            div.style.gridTemplateColumns = '1.5fr 1fr 0.7fr 1.5fr 0.3fr';
            div.style.gap = '8px';
            div.style.alignItems = 'center';
            div.innerHTML = `
                <select class="asset-type">
                    <option value="primary-residence">Primary Residence</option>
                    <option value="rental-property">Rental Property</option>
                    <option value="vacation-property">Vacation Property</option>
                    <option value="commercial-real-estate">Commercial Real Estate</option>
                    <option value="business-ownership">Business Ownership</option>
                    <option value="vehicles">Vehicles</option>
                    <option value="precious-metals">Precious Metals</option>
                    <option value="collectibles">Collectibles/Art</option>
                    <option value="intellectual-property">Intellectual Property</option>
                    <option value="other-fixed">Other Fixed</option>
                </select>
                <input type="text" class="asset-value" placeholder="$0.00" value="$0.00" onchange="formatCurrency(this)">
                <input type="text" class="asset-growth" placeholder="3.00%" value="3.00%" oninput="formatPercentageValue(this, false)" onblur="formatPercentageValue(this, true)">
                <input type="text" class="asset-notes" placeholder="Location and Notes">
                <button class="remove-btn" onclick="removeFixedAsset(this)" title="Remove this asset">×</button>
            `;
            container.appendChild(div);
        }
        
        function removeFixedAsset(button) {
            const assetItem = button.closest('.asset-item');
            if (assetItem) {
                assetItem.remove();
            }
        }
        
        // Legacy function for backward compatibility
        function addAsset() {
            addLiquidAsset();
        }
        
        function addMortgage() {
            const container = document.getElementById('mortgagesList');
            const div = document.createElement('div');
            div.className = 'mortgage-item';
            div.style.display = 'grid';
            div.style.gridTemplateColumns = '1fr 1fr 1fr 0.6fr 0.8fr 1fr 1fr 0.3fr';
            div.style.gap = '8px';
            div.style.alignItems = 'center';
            div.innerHTML = `
                <select class="mortgage-property">
                    <option value="primary">Primary Residence</option>
                    <option value="rental">Rental Property</option>
                    <option value="vacation">Vacation Home</option>
                    <option value="commercial">Commercial Property</option>
                    <option value="other">Other Property</option>
                </select>
                <input type="text" class="mortgage-original" placeholder="$0.00" onchange="formatCurrency(this); calculateMortgagePayment(this)">
                <input type="text" class="mortgage-balance" placeholder="$0.00" onchange="formatCurrency(this); calculateMortgagePayment(this)">
                <input type="number" class="mortgage-rate" placeholder="5.00" step="0.01" onchange="calculateMortgagePayment(this)">
                <input type="number" class="mortgage-term" placeholder="25" step="1" onchange="calculateMortgagePayment(this)">
                <input type="text" class="mortgage-payment" placeholder="$0.00" readonly style="background: rgba(177, 151, 119, 0.1);">
                <input type="month" class="mortgage-maturity" onchange="calculateMortgagePayment(this)">
                <button class="remove-btn" onclick="removeMortgage(this)" title="Remove this mortgage">×</button>
            `;
            container.appendChild(div);
        }
        
        function removeMortgage(button) {
            const mortgageItem = button.closest('.mortgage-item');
            if (mortgageItem) {
                mortgageItem.remove();
            }
        }
        
        function addSecuredDebt() {
            const container = document.getElementById('securedDebtsList');
            const div = document.createElement('div');
            div.className = 'liability-item secured-debt';
            div.style.cssText = 'display: grid; grid-template-columns: 1.2fr 0.7fr 0.4fr 0.7fr 60px; gap: 6px; align-items: center;';
            div.innerHTML = `
                <select class="liability-type">
                    <option value="vehicle">Vehicle Loan</option>
                    <option value="vehicle-lease">Vehicle Lease</option>
                    <option value="boat">Boat/RV Loan</option>
                    <option value="equipment">Equipment Loan</option>
                    <option value="secured-loan">Secured Personal Loan</option>
                    <option value="other-secured">Other Secured</option>
                </select>
                <input type="text" class="liability-balance" placeholder="$0.00" onchange="formatCurrency(this)">
                <div style="position: relative;">
                    <input type="number" class="liability-rate" placeholder="8.00" step="0.1" style="width: 100%; padding-right: 25px;">
                    <span class="percentage-symbol" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #b19777;">%</span>
                </div>
                <input type="text" class="liability-payment" placeholder="$0.00" onchange="formatCurrency(this)">
                <button class="remove-btn" onclick="removeDebtItem(this)" title="Remove this debt">×</button>
            `;
            container.appendChild(div);
        }
        
        function addUnsecuredDebt() {
            const container = document.getElementById('unsecuredDebtsList');
            const div = document.createElement('div');
            div.className = 'liability-item unsecured-debt';
            div.style.cssText = 'display: grid; grid-template-columns: 1.2fr 0.7fr 0.4fr 0.7fr 60px; gap: 6px; align-items: center;';
            div.innerHTML = `
                <select class="liability-type">
                    <option value="credit-card">Credit Card</option>
                    <option value="line-of-credit">Line of Credit</option>
                    <option value="personal-loan">Personal Loan</option>
                    <option value="student-loan">Student Loan</option>
                    <option value="payday-loan">Payday Loan</option>
                    <option value="other-unsecured">Other Unsecured</option>
                </select>
                <input type="text" class="liability-balance" placeholder="$0.00" onchange="formatCurrency(this)">
                <div style="position: relative;">
                    <input type="number" class="liability-rate" placeholder="19.00" step="0.1" style="width: 100%; padding-right: 25px;">
                    <span class="percentage-symbol" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #b19777;">%</span>
                </div>
                <input type="text" class="liability-payment" placeholder="$0.00" onchange="formatCurrency(this)">
                <button class="remove-btn" onclick="removeDebtItem(this)" title="Remove this debt">×</button>
            `;
            container.appendChild(div);
        }
        
        // Mortgage payment calculation function
        function calculateMortgagePayment(element) {
            const mortgageItem = element.closest('.mortgage-item');
            if (!mortgageItem) return;
            
            const balanceInput = mortgageItem.querySelector('.mortgage-balance');
            const rateInput = mortgageItem.querySelector('.mortgage-rate');
            const termInput = mortgageItem.querySelector('.mortgage-term');
            const paymentInput = mortgageItem.querySelector('.mortgage-payment');
            const maturityInput = mortgageItem.querySelector('.mortgage-maturity');
            
            // Get values
            const balanceStr = balanceInput.value.replace(/[^0-9.]/g, '');
            const balance = parseFloat(balanceStr) || 0;
            const annualRate = parseFloat(rateInput.value) / 100 || 0;
            const termYears = parseFloat(termInput.value) || 0;
            
            if (balance > 0 && annualRate > 0 && termYears > 0) {
                // Calculate monthly payment using standard mortgage formula
                const monthlyRate = annualRate / 12;
                const numPayments = termYears * 12;
                
                const monthlyPayment = balance * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                                     (Math.pow(1 + monthlyRate, numPayments) - 1);
                
                // Format and display payment
                paymentInput.value = '$' + monthlyPayment.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                // Maturity date is manually entered by user
            } else {
                paymentInput.value = '$0.00';
            }
        }
        
        // Legacy function for backward compatibility
        function addLiability() {
            addUnsecuredDebt();
        }
        
        function addInsurance() {
            const container = document.getElementById('insuranceList');
            const div = document.createElement('div');
            div.className = 'insurance-item';
            div.style.display = 'grid';
            div.style.gridTemplateColumns = '1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 0.3fr';
            div.style.gap = '8px';
            div.style.alignItems = 'center';
            div.innerHTML = `
                <div class="form-group">
                    <label>Policy Type:</label>
                    <select class="insurance-type" onchange="updateInsuranceTerm(this)">
                        <option value="term-life">Term Life</option>
                        <option value="whole-life">Whole Life</option>
                        <option value="universal-life">Universal Life</option>
                        <option value="disability">Disability</option>
                        <option value="critical-illness">Critical Illness</option>
                        <option value="health">Health/Extended Health</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Insurance Company:</label>
                    <input type="text" class="insurance-company" placeholder="e.g., Manulife, Sun Life">
                </div>
                <div class="form-group">
                    <label>Coverage Amount ($):</label>
                    <input type="text" class="insurance-amount" step="10000" placeholder="$0.00" onchange="handleInsuranceChange(this)">
                </div>
                <div class="form-group">
                    <label>Monthly Premium ($):</label>
                    <input type="text" class="insurance-premium" step="10" placeholder="$0.00" onchange="handleInsuranceChange(this)">
                </div>
                <div class="form-group">
                    <label>Term/Duration:</label>
                    <input type="text" class="insurance-term" placeholder="e.g., 20 years, Age 65">
                </div>
                <div class="form-group">
                    <label>Expiry Date:</label>
                    <input type="month" class="insurance-expiry" placeholder="MM/YYYY">
                </div>
                <div class="form-group">
                    <label>Policy Owner:</label>
                    <select class="insurance-owner">
                        <option value="self">Self</option>
                        <option value="spouse">Spouse</option>
                        <option value="joint">Joint</option>
                        <option value="trust">Trust</option>
                        <option value="business">Business</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Primary Beneficiary:</label>
                    <input type="text" class="insurance-beneficiary" placeholder="Name or relationship">
                </div>
                <button class="remove-btn" onclick="removeInsurancePolicy(this)" title="Remove this insurance policy">×</button>
            `;
            container.appendChild(div);
        }
        
        function removeInsurancePolicy(button) {
            const insuranceItem = button.closest('.insurance-item');
            if (insuranceItem) {
                insuranceItem.remove();
            }
        }
        
        // Auto-populate term field based on policy type
        function updateInsuranceTerm(selectElement) {
            const row = selectElement.closest('.insurance-item');
            if (!row) return;
            
            const termInput = row.querySelector('.insurance-term');
            const policyType = selectElement.value;
            
            // Auto-populate term for whole life and universal life
            if (policyType === 'whole-life' || policyType === 'universal-life') {
                termInput.value = '100';
            } else if (policyType === 'term-life') {
                termInput.value = ''; // Let user enter term years
                termInput.placeholder = 'e.g., 10, 20, 30 years';
            } else if (policyType === 'disability') {
                termInput.value = '';
                termInput.placeholder = 'e.g., To age 65';
            } else {
                termInput.value = '';
                termInput.placeholder = 'e.g., 20 years, Age 65';
            }
        }
        
        // Automatic DIME calculation for both partners
        function updateDimeCalculations() {
            updateDimeAnalysis('partner1');
            updateDimeAnalysis('partner2');
            
            // Refresh DIME charts if on Insurance tab
            if (document.querySelector('.tab-content.active')?.id === 'insurance') {
                setTimeout(() => createDimeCharts(), 100);
            }
        }
        
        function calculateIncomeReplacementYears() {
            const spouse1DOB = document.getElementById('spouse1DOB').value;
            const spouse1RetireAge = parseInt(document.getElementById('spouse1RetireAge').value) || 65;
            const spouse2DOB = document.getElementById('spouse2DOB').value;
            const spouse2RetireAge = parseInt(document.getElementById('spouse2RetireAge').value) || 65;
            
            if (spouse1DOB) {
                const spouse1Age = calculateAge(spouse1DOB);
                if (spouse1Age > 0) {
                    const yearsToRetirement1 = Math.max(1, spouse1RetireAge - spouse1Age);
                    document.getElementById('incomeReplacement1').value = yearsToRetirement1;
                }
            }
            
            if (spouse2DOB) {
                const spouse2Age = calculateAge(spouse2DOB);
                if (spouse2Age > 0) {
                    const yearsToRetirement2 = Math.max(1, spouse2RetireAge - spouse2Age);
                    document.getElementById('incomeReplacement2').value = yearsToRetirement2;
                }
            }
            
            // Update calculations after changing the values
            updateDimeCalculations();
        }
        
        function calculateSmartEducationFunding(dependent, inflationRate) {
            const currentAge = dependent.age;
            const educationStartAge = dependent.eduAge || 18;
            const studyYears = dependent.studyYears || 4;
            const annualCost = dependent.eduCost || 12000;
            
            // If student hasn't started yet, calculate full funding needed
            if (currentAge < educationStartAge) {
                const yearsToEducation = educationStartAge - currentAge;
                const inflatedCost = annualCost * Math.pow(1 + inflationRate, yearsToEducation);
                return inflatedCost * studyYears;
            }
            
            // If student is currently in education
            if (currentAge >= educationStartAge && currentAge < (educationStartAge + studyYears)) {
                const yearsCompleted = currentAge - educationStartAge;
                const yearsRemaining = studyYears - yearsCompleted;
                // Only need funding for remaining years (already paid for completed years)
                const currentCost = annualCost; // Assuming current cost for remaining years
                return currentCost * yearsRemaining;
            }
            
            // If student has completed education, no funding needed
            return 0;
        }
        
        // Add new income source
        function addIncomeSource() {
            const container = document.getElementById('otherIncomeList');
            const div = document.createElement('div');
            div.className = 'income-item';
            div.innerHTML = `
                <select class="income-type" onchange="updateIncomeDisplay()">
                    <option value="rental">Rental Income</option>
                    <option value="investment">Investment Income</option>
                    <option value="vacation-rental">Vacation Rental</option>
                    <option value="royalties">Royalties</option>
                    <option value="pension">Pension Income</option>
                    <option value="social-benefits">Social Benefits</option>
                    <option value="freelance">Freelance/Contract</option>
                    <option value="side-business">Side Business</option>
                    <option value="other">Other</option>
                </select>
                <input type="text" class="income-amount" placeholder="$0.00" oninput="formatCurrency(this)" onblur="formatCurrencyComplete(this)" onchange="updateIncomeDisplay()">
                <input type="text" class="income-description" placeholder="Description (optional)">
                <button type="button" class="remove-btn" onclick="removeIncomeSource(this)">Remove</button>
            `;
            container.appendChild(div);
        }
        
        // Remove income source
        function removeIncomeSource(button) {
            const incomeItem = button.closest('.income-item');
            const container = document.getElementById('otherIncomeList');
            if (container.children.length > 1) {
                incomeItem.remove();
                updateIncomeDisplay();
            }
        }
        
        // Phone number formatting: (403)-921-6700
        function formatPhoneNumber(input) {
            // Remove all non-digits
            let phoneNumber = input.value.replace(/\D/g, '');
            
            // Limit to 10 digits
            if (phoneNumber.length > 10) {
                phoneNumber = phoneNumber.substring(0, 10);
            }
            
            // Format as (XXX)-XXX-XXXX
            if (phoneNumber.length >= 6) {
                input.value = `(${phoneNumber.substring(0, 3)})-${phoneNumber.substring(3, 6)}-${phoneNumber.substring(6)}`;
            } else if (phoneNumber.length >= 3) {
                input.value = `(${phoneNumber.substring(0, 3)})-${phoneNumber.substring(3)}`;
            } else if (phoneNumber.length > 0) {
                input.value = `(${phoneNumber}`;
            } else {
                input.value = '';
            }
        }
        
        // Date formatting: Store YYYYMMDD and show formatted date in label
        function formatDateInput(input) {
            // Remove all non-digits
            let dateString = input.value.replace(/\D/g, '');
            
            // Limit to 8 digits (YYYYMMDD)
            if (dateString.length > 8) {
                dateString = dateString.substring(0, 8);
            }
            
            // Store just the numbers in the input field
            input.value = dateString;
            
            // Find the corresponding label and update it with formatted date
            const label = input.parentNode.querySelector('label');
            if (label) {
                const baseLabelText = label.textContent.split(':')[0] + ':';
                
                if (dateString.length >= 8) {
                    // Full date: show formatted date
                    const year = dateString.substring(0, 4);
                    const month = dateString.substring(4, 6);
                    const day = dateString.substring(6, 8);
                    
                    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                                  'July', 'August', 'September', 'October', 'November', 'December'];
                    
                    const monthName = months[parseInt(month) - 1];
                    const dayNum = parseInt(day);
                    
                    if (monthName && dayNum >= 1 && dayNum <= 31) {
                        label.innerHTML = `${baseLabelText} <span style="color: white; font-weight: normal;">${monthName} ${dayNum}, ${year}</span>`;
                        
                        // Store the formatted date in a data attribute for calculateAge
                        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                        input.setAttribute('data-formatted-date', formattedDate);
                        
                        // Trigger life expectancy update after complete date
                        setTimeout(() => input.dispatchEvent(new Event('change')), 0);
                    } else {
                        label.textContent = baseLabelText;
                        input.removeAttribute('data-formatted-date');
                    }
                } else {
                    // Incomplete date: show just the base label
                    label.textContent = baseLabelText;
                }
            }
            
            // Set cursor to end
            const newPosition = dateString.length;
            input.setSelectionRange(newPosition, newPosition);
        }
        
        // Update life expectancy based on gender selection (Canadian averages)
        function updateLifeExpectancy(partner) {
            updateLifeExpectancyFromAge(partner);
        }
        
        // Calculate life expectancy based on current age and gender (projected values)
        function updateLifeExpectancyFromAge(partner) {
            const dobInput = document.getElementById(partner + 'DOB');
            const genderSelect = document.getElementById(partner + 'Gender');
            const lifeExpectancyInput = document.getElementById(partner + 'LifeExpectancy');
            
            if (!dobInput.value) return;
            
            const currentAge = calculateAge(dobInput.value);
            const gender = genderSelect.value;
            
            if (currentAge && gender) {
                // Canadian life expectancy tables with projected values based on current age
                // Source: Statistics Canada Life Tables 2020-2022 with projections
                const lifeExpectancyTables = {
                    male: {
                        20: 82.1, 25: 82.2, 30: 82.4, 35: 82.6, 40: 82.9, 45: 83.2,
                        50: 83.6, 55: 84.1, 60: 84.8, 65: 85.6, 70: 86.7, 75: 88.1,
                        80: 89.8, 85: 92.0, 90: 94.8
                    },
                    female: {
                        20: 86.8, 25: 86.9, 30: 87.0, 35: 87.2, 40: 87.4, 45: 87.7,
                        50: 88.1, 55: 88.6, 60: 89.2, 65: 90.0, 70: 91.0, 75: 92.3,
                        80: 93.9, 85: 95.9, 90: 98.3
                    }
                };
                
                // Find closest age bracket
                let projectedLifeExpectancy = gender === 'male' ? 79 : 84; // fallback
                
                if (lifeExpectancyTables[gender]) {
                    const ages = Object.keys(lifeExpectancyTables[gender]).map(Number).sort((a, b) => a - b);
                    
                    // Find the closest age bracket
                    let closestAge = ages[0];
                    for (let age of ages) {
                        if (currentAge >= age) {
                            closestAge = age;
                        } else {
                            break;
                        }
                    }
                    
                    projectedLifeExpectancy = lifeExpectancyTables[gender][closestAge];
                }
                
                lifeExpectancyInput.value = Math.round(projectedLifeExpectancy);
            }
        }
        
        // Calculate DIME analysis for specific partner
        function updateDimeAnalysis(partner) {
            try {
                // Check if required elements exist before calling collectAllData
                const expensesId = partner === 'partner1' ? 'finalExpenses1' : 'finalExpenses2';
                const replacementId = partner === 'partner1' ? 'incomeReplacement1' : 'incomeReplacement2';
                
                if (!document.getElementById(expensesId) || !document.getElementById(replacementId)) {
                    console.log('DIME calculation skipped - required elements not found for ' + partner);
                    return;
                }
                
                const data = collectAllData();
                
                // Calculate total liabilities (shared between both partners)
                const totalLiabilities = data.liabilities.reduce((sum, liability) => sum + liability.balance, 0);
                
                // Calculate education fund (shared between both partners) - smart calculation
                const totalEducationCosts = data.family.dependents.reduce((total, dependent) => {
                    return total + calculateSmartEducationFunding(dependent, data.assumptions.inflationRate || 0.03);
                }, 0);
                
                // Get partner-specific data
                const isPartner1 = partner === 'partner1';
                const partnerIncome = isPartner1 ? data.income.spouse1.annual : data.income.spouse2.annual;
                
                // Get DIME values
                const finalExpensesStr = document.getElementById(expensesId).value.replace(/[^0-9.]/g, '');
                const finalExpenses = parseFloat(finalExpensesStr) || 15000;
                const incomeReplacementYears = parseInt(document.getElementById(replacementId).value) || 10;
                
                // Calculate DIME components with inflation adjustments
                const D = finalExpenses; // Debt (final expenses)
                
                // Income replacement with inflation - calculate present value of inflating income stream
                const inflationRate = data.assumptions.inflationRate || 0.03;
                const discountRate = data.assumptions.postRetireRate || 0.04; // Discount rate for present value
                
                let I = 0;
                if (incomeReplacementYears > 0 && partnerIncome > 0) {
                    if (Math.abs(discountRate - inflationRate) < 0.0001) {
                        // If discount rate equals inflation rate, use simple sum with inflation
                        I = partnerIncome * incomeReplacementYears * Math.pow(1 + inflationRate, incomeReplacementYears / 2);
                    } else {
                        // Present value of growing annuity (income growing with inflation)
                        const growthFactor = 1 + inflationRate;
                        const discountFactor = 1 + discountRate;
                        I = partnerIncome * (1 - Math.pow(growthFactor / discountFactor, incomeReplacementYears)) / (discountRate - inflationRate);
                    }
                }
                
                const M = totalLiabilities; // Mortgage/debt
                const E = totalEducationCosts; // Education (already inflation-adjusted)
                
                const totalNeed = D + I + M + E;
                const roundedNeed = Math.ceil(totalNeed / 10000) * 10000; // Round up to nearest 10k
                
                // Update auto-calculated fields
                document.getElementById(isPartner1 ? 'mortgageDebt1' : 'mortgageDebt2').value = 
                    '$' + M.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById(isPartner1 ? 'educationFund1' : 'educationFund2').value = 
                    '$' + E.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                // Update large display
                const prefix = isPartner1 ? 'partner1' : 'partner2';
                document.getElementById(prefix + 'TotalDisplay').textContent = 
                    '$' + roundedNeed.toLocaleString('en-US', {maximumFractionDigits: 0});
                
                // Create DIME breakdown table
                const tableHtml = `
                    <div style="background: #444; border: 1px solid #666; border-radius: 8px; padding: 20px; color: #ffffff;">
                        <h5 style="color: #b19777; margin-bottom: 15px;">DIME Method Breakdown</h5>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <strong style="color: #c9a96e;">D - Debt (Final Expenses):</strong>
                            <span>$${D.toLocaleString()}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <strong style="color: #c9a96e;">I - Income Replacement (${incomeReplacementYears} years @ ${(inflationRate*100).toFixed(1)}% inflation):</strong>
                            <span>$${I.toLocaleString()}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <strong style="color: #c9a96e;">M - Mortgage/Debt Payoff:</strong>
                            <span>$${M.toLocaleString()}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <strong style="color: #c9a96e;">E - Education Fund:</strong>
                            <span>$${E.toLocaleString()}</span>
                        </div>
                        <hr style="border: 1px solid #666; margin: 15px 0;">
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <strong style="color: #ffffff; font-size: 1.1em;">Total Insurance Needed:</strong>
                            <strong style="color: #ffffff; font-size: 1.1em;">$${totalNeed.toLocaleString()}</strong>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <strong style="color: #c9a96e; font-size: 1.2em;">Rounded to Nearest $10k:</strong>
                            <strong style="color: #c9a96e; font-size: 1.2em;">$${roundedNeed.toLocaleString()}</strong>
                        </div>
                    </div>
                `;
                
                document.getElementById(prefix + 'DimeTable').innerHTML = tableHtml;
                
                // Update summary cards if they exist
                const totalNeedElement = document.getElementById(prefix + 'TotalNeed');
                if (totalNeedElement) {
                    totalNeedElement.textContent = '$' + roundedNeed.toLocaleString('en-US', {maximumFractionDigits: 0});
                }
                
            } catch (error) {
                console.error('Error calculating DIME analysis for ' + partner + ':', error);
                // Set default value on error
                const prefix = partner === 'partner1' ? 'partner1' : 'partner2';
                document.getElementById(prefix + 'TotalDisplay').textContent = '$15,000';
            }
        }
        
        // Legacy function kept for compatibility
        function calculateDimeAnalysis(partner) {
            try {
                const data = collectAllData();
                
                // Calculate total liabilities (shared between both partners)
                const totalLiabilities = data.liabilities.reduce((sum, liability) => sum + liability.balance, 0);
                
                // Calculate education fund (shared between both partners) - smart calculation
                const totalEducationCosts = data.family.dependents.reduce((total, dependent) => {
                    return total + calculateSmartEducationFunding(dependent, data.assumptions.inflationRate || 0.03);
                }, 0);
                
                // Get partner-specific data
                const isPartner1 = partner === 'partner1';
                const partnerIncome = isPartner1 ? data.income.spouse1.annual : data.income.spouse2.annual;
                const finalExpensesId = isPartner1 ? 'finalExpenses1' : 'finalExpenses2';
                const incomeReplacementId = isPartner1 ? 'incomeReplacement1' : 'incomeReplacement2';
                
                // Get DIME values
                const finalExpensesStr = document.getElementById(finalExpensesId).value.replace(/[^0-9.]/g, '');
                const finalExpenses = parseFloat(finalExpensesStr) || 15000;
                const incomeReplacementYears = parseInt(document.getElementById(incomeReplacementId).value) || 10;
                
                // Calculate DIME components with inflation adjustments
                const D = finalExpenses; // Debt (final expenses)
                
                // Income replacement with inflation - calculate present value of inflating income stream
                const inflationRate = data.assumptions.inflationRate || 0.03;
                const discountRate = data.assumptions.postRetireRate || 0.04; // Discount rate for present value
                
                let I = 0;
                if (incomeReplacementYears > 0 && partnerIncome > 0) {
                    if (Math.abs(discountRate - inflationRate) < 0.0001) {
                        // If discount rate equals inflation rate, use simple sum with inflation
                        I = partnerIncome * incomeReplacementYears * Math.pow(1 + inflationRate, incomeReplacementYears / 2);
                    } else {
                        // Present value of growing annuity (income growing with inflation)
                        const growthFactor = 1 + inflationRate;
                        const discountFactor = 1 + discountRate;
                        I = partnerIncome * (1 - Math.pow(growthFactor / discountFactor, incomeReplacementYears)) / (discountRate - inflationRate);
                    }
                }
                
                const M = totalLiabilities; // Mortgage/debt
                const E = totalEducationCosts; // Education (already inflation-adjusted)
                
                const totalNeed = D + I + M + E;
                const roundedNeed = Math.ceil(totalNeed / 10000) * 10000; // Round up to nearest 10k
                
                // Calculate current coverage for this partner
                const currentCoverage = data.insurance.reduce((sum, policy) => {
                    // Assume life insurance policies are split equally or check owner field
                    if (policy.type.includes('life')) {
                        const policyOwner = policy.owner || 'joint';
                        if (policyOwner === 'joint' || 
                            (isPartner1 && policyOwner === 'self') || 
                            (!isPartner1 && policyOwner === 'spouse')) {
                            return sum + policy.amount;
                        }
                    }
                    return sum;
                }, 0);
                
                const gap = Math.max(0, roundedNeed - currentCoverage);
                
                // Calculate monthly premiums for this partner
                const monthlyPremiums = data.insurance.reduce((sum, policy) => {
                    const policyOwner = policy.owner || 'joint';
                    if (policyOwner === 'joint' || 
                        (isPartner1 && policyOwner === 'self') || 
                        (!isPartner1 && policyOwner === 'spouse')) {
                        return sum + policy.premium;
                    }
                    return sum;
                }, 0);
                
                // Update auto-calculated fields
                document.getElementById(isPartner1 ? 'mortgageDebt1' : 'mortgageDebt2').value = 
                    '$' + M.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById(isPartner1 ? 'educationFund1' : 'educationFund2').value = 
                    '$' + E.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                // Update results display
                const prefix = isPartner1 ? 'partner1' : 'partner2';
                document.getElementById(prefix + 'TotalNeed').textContent = 
                    '$' + roundedNeed.toLocaleString('en-US', {maximumFractionDigits: 0});
                document.getElementById(prefix + 'CurrentCoverage').textContent = 
                    '$' + currentCoverage.toLocaleString('en-US', {maximumFractionDigits: 0});
                document.getElementById(prefix + 'Gap').textContent = 
                    '$' + gap.toLocaleString('en-US', {maximumFractionDigits: 0});
                document.getElementById(prefix + 'Premiums').textContent = 
                    '$' + monthlyPremiums.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                // Create DIME breakdown table
                const tableHtml = `
                    <div style="background: #444; border: 1px solid #666; border-radius: 8px; padding: 20px; color: #ffffff;">
                        <h5 style="color: #b19777; margin-bottom: 15px;">DIME Method Breakdown</h5>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <strong style="color: #c9a96e;">D - Debt (Final Expenses):</strong>
                            <span>$${D.toLocaleString()}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <strong style="color: #c9a96e;">I - Income Replacement (${incomeReplacementYears} years @ ${(inflationRate*100).toFixed(1)}% inflation):</strong>
                            <span>$${I.toLocaleString()}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <strong style="color: #c9a96e;">M - Mortgage/Debt Payoff:</strong>
                            <span>$${M.toLocaleString()}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <strong style="color: #c9a96e;">E - Education Fund:</strong>
                            <span>$${E.toLocaleString()}</span>
                        </div>
                        <hr style="border: 1px solid #666; margin: 15px 0;">
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <strong style="color: #ffffff; font-size: 1.1em;">Total Insurance Needed:</strong>
                            <strong style="color: #ffffff; font-size: 1.1em;">$${totalNeed.toLocaleString()}</strong>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <strong style="color: #c9a96e; font-size: 1.2em;">Rounded to Nearest $10k:</strong>
                            <strong style="color: #c9a96e; font-size: 1.2em;">$${roundedNeed.toLocaleString()}</strong>
                        </div>
                    </div>
                `;
                
                document.getElementById(prefix + 'DimeTable').innerHTML = tableHtml;
                
                // Show results section
                document.getElementById(prefix + 'DimeResults').style.display = 'block';
                
                // Update title with partner names
                updateDimeTitles();
                
            } catch (error) {
                console.error('Error calculating DIME analysis:', error);
                alert('Error calculating DIME analysis. Please check your data.');
            }
        }
        
        // Calculate blended tax rate based on TFSA limits and registered rate
        function updateBlendedTaxRate() {
            const registeredRate = parsePercentageValue(document.getElementById('registeredTaxRate').value) || 28.5;
            
            // 2025 TFSA contribution limit: $7,000 annually = $583.33 monthly
            // For retirees, max TFSA withdrawal capacity is typically $3,500/month
            const tfsaMonthlyMax = 3500;
            const tfsaTaxRate = 0; // TFSA withdrawals are tax-free
            
            // Assume 50/50 split between TFSA and Registered for blended approach
            const tfsaPercentage = 0.5;
            const registeredPercentage = 0.5;
            
            const blendedRate = (tfsaTaxRate * tfsaPercentage) + (registeredRate * registeredPercentage);
            
            // Update the field and calculation display
            document.getElementById('blendedTaxRate').value = blendedRate.toFixed(2);
            document.getElementById('blendedRateCalculation').innerHTML = 
                `Calculation: (${tfsaTaxRate}% × ${(tfsaPercentage*100)}%) + (${registeredRate}% × ${(registeredPercentage*100)}%) = ${blendedRate.toFixed(2)}%<br>` +
                `TFSA Max: $${tfsaMonthlyMax.toLocaleString()}/month tax-free`;
        }
        
        // Update DIME titles with partner names
        function updateDimeTitles() {
            const spouse1Name = document.getElementById('spouse1Name').value || 'Partner 1';
            const spouse2Name = document.getElementById('spouse2Name').value || 'Partner 2';
            
            document.getElementById('partner1DimeTitle').textContent = 
                `💰 ${spouse1Name} Insurance Needs Analysis (DIME Method)`;
            document.getElementById('partner2DimeTitle').textContent = 
                `💰 ${spouse2Name} Insurance Needs Analysis (DIME Method)`;
                
            // Update the descriptions to use partner names too
            const partner1Desc = document.querySelector('#partner1DimeTitle + p');
            const partner2Desc = document.querySelector('#partner2DimeTitle + p');
            
            if (partner1Desc) {
                partner1Desc.textContent = `Calculate insurance needed if ${spouse1Name} passes away first`;
            }
            if (partner2Desc) {
                partner2Desc.textContent = `Calculate insurance needed if ${spouse2Name} passes away first`;
            }
            
            // Update income replacement labels
            const incomeLabel1 = document.getElementById('incomeReplacementLabel1');
            const incomeLabel2 = document.getElementById('incomeReplacementLabel2');
            
            if (incomeLabel1) {
                incomeLabel1.textContent = `Years to replace ${spouse1Name}'s income`;
            }
            if (incomeLabel2) {
                incomeLabel2.textContent = `Years to replace ${spouse2Name}'s income`;
            }
        }
        
        function saveData() {
            try {
                const data = collectAllData();
                const lastName = data.family.spouse1.name ? data.family.spouse1.name.split(' ').pop() : 'Client';
                const today = new Date();
                const dateStr = today.getFullYear() + '-' + 
                              String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                              String(today.getDate()).padStart(2, '0');
                
                let finNumber = 0;
                if (window.currentCalculations) {
                    finNumber = window.currentCalculations.scenarios.registered.preserve.finNumber;
                }
                
                const filename = `${dateStr} ${lastName} FIN ${Math.round(finNumber/1000)}k.json`;
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Set flag to indicate data has been saved
                window.dataSaved = true;
                
                alert('Data saved successfully!');
            } catch (error) {
                alert('Error saving data: ' + error.message);
                throw error; // Re-throw for caller to handle
            }
        }
        
        function updateLiabilityPayment(balanceInput) {
            const balance = parseFloat(balanceInput.value) || 0;
            const paymentInput = balanceInput.parentElement.parentElement.querySelector('.liability-payment');
            const payment = Math.max(10, balance * 0.01);
            paymentInput.value = payment.toFixed(0);
        }
        
        // Update income display with real-time calculations
        function updateIncomeDisplay() {
            try {
                // Partner 1 Income Calculation
                const rate1 = parseFloat(document.getElementById('income1Rate').value.replace(/[^0-9.]/g, '')) || 0;
                const frequency1 = document.getElementById('income1Frequency').value;
                const hours1 = parseFloat(document.getElementById('income1Hours').value) || 40;
                
                const annual1 = calculateAnnualIncome(rate1, frequency1, hours1);
                
                // Partner 2 Income Calculation
                const rate2 = parseFloat(document.getElementById('income2Rate').value.replace(/[^0-9.]/g, '')) || 0;
                const frequency2 = document.getElementById('income2Frequency').value;
                const hours2 = parseFloat(document.getElementById('income2Hours').value) || 40;
                
                const annual2 = calculateAnnualIncome(rate2, frequency2, hours2);
                
                // Calculate total from other income sources
                let otherIncomeTotal = 0;
                document.querySelectorAll('.income-item').forEach(item => {
                    const amount = parseFloat(item.querySelector('.income-amount').value.replace(/[^0-9.]/g, '')) || 0;
                    otherIncomeTotal += amount * 12; // Convert monthly to annual
                });
                
                // NEW: Get partner names for personalization
                const partner1Name = document.getElementById('spouse1Name').value.trim();
                const partner2Name = document.getElementById('spouse2Name').value.trim();
                
                // NEW: Create personalized titles or fall back to generic ones
                const income1Title = partner1Name ? `💰 ${partner1Name} Income` : '💰 Partner 1 Income';
                const income2Title = partner2Name ? `💰 ${partner2Name} Income` : '💰 Partner 2 Income';
                
                // Calculate total household income including other sources
                const totalHouseholdIncome = annual1 + annual2 + otherIncomeTotal;
                
                // Calculate take-home hourly rates (regardless of frequency)
                const hoursPerWeek1 = hours1 || 40;
                const hoursPerWeek2 = hours2 || 40;
                const takeHomeHourly1 = annual1 > 0 ? annual1 / (hoursPerWeek1 * 52) : 0;
                const takeHomeHourly2 = annual2 > 0 ? annual2 / (hoursPerWeek2 * 52) : 0;
                
                // Update titles with calculated amounts, personalized names, and take-home hourly rate
                document.getElementById('partner1IncomeTitle').innerHTML = 
                    `${income1Title} - $${annual1.toLocaleString()} per year` + 
                    (takeHomeHourly1 > 0 ? ` <span style="font-size: 0.8em; color: white; font-weight: normal;">($${takeHomeHourly1.toFixed(2)}/hour take-home)</span>` : '');
                    
                document.getElementById('partner2IncomeTitle').innerHTML = 
                    `${income2Title} - $${annual2.toLocaleString()} per year` + 
                    (takeHomeHourly2 > 0 ? ` <span style="font-size: 0.8em; color: white; font-weight: normal;">($${takeHomeHourly2.toFixed(2)}/hour take-home)</span>` : '');
                    
                // Trigger DIME calculations when income changes
                setTimeout(() => updateDimeCalculations(), 100);
                    
            } catch (error) {
                console.error('Error updating income display:', error);
            }
        }
        
        // NEW: Function to update partner names throughout the application
        function updatePartnerNames() {
            const partner1Name = document.getElementById('spouse1Name').value.trim();
            const partner2Name = document.getElementById('spouse2Name').value.trim();
            
            // Update family tab headers with actual names or fallback to generic
            document.getElementById('partner1Header').textContent = partner1Name ? `👤 ${partner1Name}` : '👤 Partner 1';
            document.getElementById('partner2Header').textContent = partner2Name ? `👤 ${partner2Name}` : '👤 Partner 2';
            
            // Update DIME analysis titles with personalized names
            updateDimeTitles();
            
            // Update CPP/OAS labels in assumptions tab with personalized names
            const cpp1Label = partner1Name ? `${partner1Name} CPP Monthly ($):` : 'Partner 1 CPP Monthly ($):';
            const oas1Label = partner1Name ? `${partner1Name} OAS Monthly ($):` : 'Partner 1 OAS Monthly ($):';
            const cpp2Label = partner2Name ? `${partner2Name} CPP Monthly ($):` : 'Partner 2 CPP Monthly ($):';
            const oas2Label = partner2Name ? `${partner2Name} OAS Monthly ($):` : 'Partner 2 OAS Monthly ($):';
            
            document.getElementById('cpp1Label').textContent = cpp1Label;
            document.getElementById('oas1Label').textContent = oas1Label;
            document.getElementById('cpp2Label').textContent = cpp2Label;
            document.getElementById('oas2Label').textContent = oas2Label;
            
            // Also update income displays to reflect name changes
            updateIncomeDisplay();
            
            // Refresh DIME charts if on Insurance tab to update partner names
            if (document.querySelector('.tab-content.active')?.id === 'insurance') {
                setTimeout(() => createDimeCharts(), 100);
            }
        }

        // Show/hide downsize value field based on downsize intent selection
        function toggleDownsizeField() {
            const downsizeIntent = document.getElementById('downsizeIntent').value;
            const downsizeValueGroup = document.getElementById('downsizeValueGroup');
            
            if (downsizeIntent === 'yes') {
                downsizeValueGroup.style.display = 'block';
            } else {
                downsizeValueGroup.style.display = 'none';
                // Clear the value when hiding
                document.getElementById('downsizeValue').value = '$0.00';
            }
        }

        // Show/hide retirement rent field based on retirement housing selection
        function toggleRentField() {
            const retirementHousing = document.getElementById('retirementHousing').value;
            const retirementRentGroup = document.getElementById('retirementRentGroup');
            
            if (retirementHousing === 'rent') {
                retirementRentGroup.style.display = 'block';
            } else {
                retirementRentGroup.style.display = 'none';
                // Reset to default value when hiding
                document.getElementById('retirementRent').value = '$2,200.00';
            }
        }

        /* // Initialize the field visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            toggleDownsizeField();
            toggleRentField();
        }); */

        // Calculate annual income from frequency
        function calculateAnnualIncome(rate, frequency, hours = 40) {
            if (!rate || rate <= 0) return 0;
            
            const multipliers = {
                'hourly': hours * 52,
                'weekly': 52,
                'biweekly': 26,
                'monthly': 12,
                'yearly': 1
            };
            return rate * (multipliers[frequency] || 1);
        }
        
        // Calculate age from date of birth for dependents and spouses
        function calculateAge(dob) {
            if (!dob) return 0;
            
            let dateToUse = dob;
            
            // If dob is in YYYYMMDD format (8 digits), convert to YYYY-MM-DD
            if (/^\d{8}$/.test(dob)) {
                const year = dob.substring(0, 4);
                const month = dob.substring(4, 6);
                const day = dob.substring(6, 8);
                dateToUse = `${year}-${month}-${day}`;
            }
            
            const today = new Date();
            const birth = new Date(dateToUse);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            // Adjust if birthday hasn't occurred this year
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        // Helper function to parse percentage values with % symbol
        function parsePercentageValue(value) {
            if (typeof value === 'string') {
                value = value.replace(/[^0-9.-]/g, ''); // Remove % and other non-numeric characters
            }
            return parseFloat(value) || 0;
        }

        // Collect all form data from every tab and return as structured object
        function collectAllData() {
            // Collect family data from Family tab
            const family = {
                spouse1: {
                    name: document.getElementById('spouse1Name').value,
                    dob: document.getElementById('spouse1DOB').value,
                    gender: document.getElementById('spouse1Gender').value,
                    retireAge: parseInt(document.getElementById('spouse1RetireAge').value) || 65,
                    lifeExpectancy: parseInt(document.getElementById('spouse1LifeExpectancy').value) || 85,
                    email: document.getElementById('spouse1Email').value,
                    phone: document.getElementById('spouse1Phone').value,
                    age: calculateAge(document.getElementById('spouse1DOB').value)
                },
                spouse2: {
                    name: document.getElementById('spouse2Name').value,
                    dob: document.getElementById('spouse2DOB').value,
                    gender: document.getElementById('spouse2Gender').value,
                    retireAge: parseInt(document.getElementById('spouse2RetireAge').value) || 65,
                    lifeExpectancy: parseInt(document.getElementById('spouse2LifeExpectancy').value) || 85,
                    email: document.getElementById('spouse2Email').value,
                    phone: document.getElementById('spouse2Phone').value,
                    age: calculateAge(document.getElementById('spouse2DOB').value)
                },
                dependents: []
            };
            
            // Collect all dependents from the dynamic list
            document.querySelectorAll('#dependentsList .form-row-4').forEach(row => {
                const name = row.querySelector('.dependent-name').value;
                const dob = row.querySelector('.dependent-dob').value;
                const eduAge = parseInt(row.querySelector('.dependent-edu-age').value) || 18;
                const studyYears = parseInt(row.querySelector('.dependent-study-years').value) || 4;
                const eduCost = parseFloat(row.querySelector('.dependent-edu-cost').value.replace(/[^0-9.]/g, '')) || 12000;
                
                // Only add if name and DOB are provided
                if (name && dob) {
                    family.dependents.push({
                        name, dob, eduAge, studyYears, eduCost,
                        age: calculateAge(dob)
                    });
                }
            });
            
            // Collect financial assumptions from Assumptions tab
            const assumptions = {
                inflationRate: parsePercentageValue(document.getElementById('inflationRate').value) / 100 || 0.028,
                preRetireRate: parsePercentageValue(document.getElementById('preRetireRate').value) / 100 || 0.065,
                postRetireRate: parsePercentageValue(document.getElementById('postRetireRate').value) / 100 || 0.04,
                retirementIncomePercent: parsePercentageValue(document.getElementById('retirementIncomePercent').value) / 100 || 0.70,
                widowReduction: parsePercentageValue(document.getElementById('widowReduction').value) / 100 || 0.70,
                currentHousing: document.getElementById('currentHousing').value,
                retirementHousing: document.getElementById('retirementHousing').value,
                downsizeIntent: document.getElementById('downsizeIntent').value === 'yes',
                downsizeValue: parseFloat(document.getElementById('downsizeValue').value.replace(/[^0-9.]/g, '')) || 0,
                retirementRent: parseFloat(document.getElementById('retirementRent').value.replace(/[^0-9.]/g, '')) || 2200,
                cpp1: parseFloat(document.getElementById('cpp1Monthly').value.replace(/[^0-9.]/g, '')) || 758,
                oas1: parseFloat(document.getElementById('oas1Monthly').value.replace(/[^0-9.]/g, '')) || 713,
                cpp2: parseFloat(document.getElementById('cpp2Monthly').value.replace(/[^0-9.]/g, '')) || 758,
                oas2: parseFloat(document.getElementById('oas2Monthly').value.replace(/[^0-9.]/g, '')) || 713,
                registeredTaxRate: parsePercentageValue(document.getElementById('registeredTaxRate').value) / 100 || 0.25,
                blendedTaxRate: parseFloat(document.getElementById('blendedTaxRate').value) / 100 || 0.15
            };
            
            // Collect goals from Goals tab
            const goals = [];
            document.querySelectorAll('.goal-item').forEach(item => {
                const type = item.querySelector('.goal-type').value;
                const description = item.querySelector('.goal-description').value;
                const years = parseInt(item.querySelector('.goal-years').value) || 0;
                const amount = parseFloat(item.querySelector('.goal-amount').value.replace(/[^0-9.]/g, '')) || 0;
                const frequency = item.querySelector('.goal-frequency').value;
                
                // Only save goals that have an amount
                if (amount > 0) {
                    goals.push({ type, description, years, amount, frequency });
                }
            });
            
            // Collect income data from Income tab
            const income = {
                spouse1: {
                    rate: parseFloat(document.getElementById('income1Rate').value.replace(/[^0-9.]/g, '')) || 0,
                    frequency: document.getElementById('income1Frequency').value,
                    hours: parseFloat(document.getElementById('income1Hours').value) || 40,
                    rental: 0,
                    business: 0
                },
                spouse2: {
                    rate: parseFloat(document.getElementById('income2Rate').value.replace(/[^0-9.]/g, '')) || 0,
                    frequency: document.getElementById('income2Frequency').value,
                    hours: parseFloat(document.getElementById('income2Hours').value) || 40,
                    rental: 0,
                    business: 0
                },
                otherSources: []
            };
            
            // Collect other income sources
            document.querySelectorAll('.income-item').forEach(item => {
                const type = item.querySelector('.income-type').value;
                const amount = parseFloat(item.querySelector('.income-amount').value.replace(/[^0-9.]/g, '')) || 0;
                const description = item.querySelector('.income-description').value;
                
                if (amount > 0) {
                    income.otherSources.push({ type, amount, description });
                }
            });
            
            // Calculate total annual incomes for reference
            income.spouse1.annual = calculateAnnualIncome(income.spouse1.rate, income.spouse1.frequency, income.spouse1.hours) + 
                                (income.spouse1.rental * 12) + (income.spouse1.business * 12);
            income.spouse2.annual = calculateAnnualIncome(income.spouse2.rate, income.spouse2.frequency, income.spouse2.hours) + 
                                (income.spouse2.rental * 12) + (income.spouse2.business * 12);
            income.otherSourcesAnnual = income.otherSources.reduce((total, source) => total + (source.amount * 12), 0);
            income.totalAnnual = income.spouse1.annual + income.spouse2.annual + income.otherSourcesAnnual;
            
            // Collect assets from Assets tab (both liquid and fixed)
            const assets = [];
            document.querySelectorAll('.asset-item').forEach(item => {
                const type = item.querySelector('.asset-type').value;
                // Handle both formatted ($X,XXX.XX) and plain number inputs
                const valueStr = item.querySelector('.asset-value').value.replace(/[^0-9.]/g, '');
                const value = parseFloat(valueStr) || 0;
                const growthStr = item.querySelector('.asset-growth').value.replace(/[^0-9.]/g, '');
                const growth = parseFloat(growthStr) / 100 || 0.01;
                const notes = item.querySelector('.asset-notes').value;
                
                // Determine if liquid or fixed asset
                const isLiquid = item.classList.contains('liquid-asset');
                const assetCategory = isLiquid ? 'liquid' : 'fixed';
                
                // Only save assets with value
                if (value > 0) {
                    assets.push({ type, value, growth, notes, category: assetCategory });
                }
            });
            
            // Collect liabilities from Liabilities tab
            const liabilities = [];
            
            // Collect mortgages
            document.querySelectorAll('.mortgage-item').forEach(item => {
                const property = item.querySelector('.mortgage-property').value;
                const originalStr = item.querySelector('.mortgage-original').value.replace(/[^0-9.]/g, '');
                const original = parseFloat(originalStr) || 0;
                const balanceStr = item.querySelector('.mortgage-balance').value.replace(/[^0-9.]/g, '');
                const balance = parseFloat(balanceStr) || 0;
                const rate = parseFloat(item.querySelector('.mortgage-rate').value) / 100 || 0;
                const term = parseInt(item.querySelector('.mortgage-term').value) || 0;
                const paymentStr = item.querySelector('.mortgage-payment').value.replace(/[^0-9.]/g, '');
                const payment = parseFloat(paymentStr) || 0;
                const maturity = item.querySelector('.mortgage-maturity').value;
                
                // Only save mortgages with balance
                if (balance > 0) {
                    liabilities.push({ type: 'mortgage-' + property, original, balance, rate, term, payment, maturity });
                }
            });
            
            // Collect other debts (secured and unsecured)
            document.querySelectorAll('.liability-item').forEach(item => {
                const type = item.querySelector('.liability-type').value;
                const balanceStr = item.querySelector('.liability-balance').value.replace(/[^0-9.]/g, '');
                const balance = parseFloat(balanceStr) || 0;
                const rate = parseFloat(item.querySelector('.liability-rate').value) / 100 || 0;
                const paymentStr = item.querySelector('.liability-payment').value.replace(/[^0-9.]/g, '');
                const payment = parseFloat(paymentStr) || 0;
                
                // Only save liabilities with balance
                if (balance > 0) {
                    liabilities.push({ type, balance, rate, payment });
                }
            });
            
            // Collect insurance from Insurance tab
            const insurance = [];
            document.querySelectorAll('#insuranceList .insurance-item').forEach(row => {
                const type = row.querySelector('.insurance-type').value;
                const company = row.querySelector('.insurance-company').value;
                const amountStr = row.querySelector('.insurance-amount').value.replace(/[^0-9.]/g, '');
                const amount = parseFloat(amountStr) || 0;
                const premiumStr = row.querySelector('.insurance-premium').value.replace(/[^0-9.]/g, '');
                const premium = parseFloat(premiumStr) || 0;
                const term = row.querySelector('.insurance-term').value;
                const expiry = row.querySelector('.insurance-expiry').value;
                const owner = row.querySelector('.insurance-owner').value;
                const beneficiary = row.querySelector('.insurance-beneficiary').value;
                
                // Only save insurance with coverage amount
                if (amount > 0) {
                    insurance.push({ type, company, amount, premium, term, expiry, owner, beneficiary });
                }
            });
            
            // Collect insurance needs analysis data (partner-specific)
            const finalExpenses1Str = document.getElementById('finalExpenses1').value.replace(/[^0-9.]/g, '');
            const finalExpenses2Str = document.getElementById('finalExpenses2').value.replace(/[^0-9.]/g, '');
            const insuranceNeeds = {
                partner1: {
                    finalExpenses: parseFloat(finalExpenses1Str) || 15000,
                    incomeReplacement: parseInt(document.getElementById('incomeReplacement1').value) || 10
                },
                partner2: {
                    finalExpenses: parseFloat(finalExpenses2Str) || 15000,
                    incomeReplacement: parseInt(document.getElementById('incomeReplacement2').value) || 10
                },
                // Backward compatibility
                finalExpenses: parseFloat(finalExpenses1Str) || 15000,
                incomeReplacement: parseInt(document.getElementById('incomeReplacement1').value) || 10
            };
            
            // Return complete data structure
            return { family, assumptions, goals, income, assets, liabilities, insurance, insuranceNeeds };
        }

        // Initialize event listeners after all functions are defined
        // Set up file input event listener for loading data - use anonymous function to avoid reference error
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Inline populateFormData function to avoid reference issues
                    function populateFormDataInline(data) {
                        // Populate family data
                        if (data.family) {
                            document.getElementById('spouse1Name').value = data.family.spouse1.name || '';
                            document.getElementById('spouse1DOB').value = data.family.spouse1.dob || '';
                            document.getElementById('spouse1Gender').value = data.family.spouse1.gender || '';
                            document.getElementById('spouse1RetireAge').value = data.family.spouse1.retireAge || 65;
                            document.getElementById('spouse1LifeExpectancy').value = data.family.spouse1.lifeExpectancy || 85;
                            document.getElementById('spouse1Email').value = data.family.spouse1.email || '';
                            document.getElementById('spouse1Phone').value = data.family.spouse1.phone || '';
                            
                            document.getElementById('spouse2Name').value = data.family.spouse2.name || '';
                            document.getElementById('spouse2DOB').value = data.family.spouse2.dob || '';
                            document.getElementById('spouse2Gender').value = data.family.spouse2.gender || '';
                            document.getElementById('spouse2RetireAge').value = data.family.spouse2.retireAge || 65;
                            document.getElementById('spouse2LifeExpectancy').value = data.family.spouse2.lifeExpectancy || 85;
                            document.getElementById('spouse2Email').value = data.family.spouse2.email || '';
                            document.getElementById('spouse2Phone').value = data.family.spouse2.phone || '';
                        }
                        
                        // Populate assumptions data
                        if (data.assumptions) {
                            document.getElementById('inflationRate').value = ((data.assumptions.inflationRate * 100).toFixed(2) || 2.8) + '%';
                            document.getElementById('preRetireRate').value = ((data.assumptions.preRetireRate * 100).toFixed(2) || 6.5) + '%';
                            document.getElementById('postRetireRate').value = ((data.assumptions.postRetireRate * 100).toFixed(2) || 4.0) + '%';
                            document.getElementById('retirementIncomePercent').value = ((data.assumptions.retirementIncomePercent * 100).toFixed(2) || 70) + '%';
                            document.getElementById('widowReduction').value = ((data.assumptions.widowReduction * 100).toFixed(2) || 70) + '%';
                            document.getElementById('currentHousing').value = data.assumptions.currentHousing || 'own';
                            document.getElementById('retirementHousing').value = data.assumptions.retirementHousing || 'own';
                            document.getElementById('downsizeIntent').value = data.assumptions.downsizeIntent ? 'yes' : 'no';
                            document.getElementById('downsizeValue').value = '$' + (data.assumptions.downsizeValue || 0).toLocaleString();
                            document.getElementById('retirementRent').value = '$' + (data.assumptions.retirementRent || 2200).toLocaleString();
                            document.getElementById('cpp1Monthly').value = '$' + (data.assumptions.cpp1 || 758).toLocaleString();
                            document.getElementById('oas1Monthly').value = '$' + (data.assumptions.oas1 || 713).toLocaleString();
                            document.getElementById('cpp2Monthly').value = '$' + (data.assumptions.cpp2 || 758).toLocaleString();
                            document.getElementById('oas2Monthly').value = '$' + (data.assumptions.oas2 || 713).toLocaleString();
                            
                            // Update conditional field visibility
                            if (typeof toggleDownsizeField === 'function') toggleDownsizeField();
                            if (typeof toggleRentField === 'function') toggleRentField();
                        }
                        
                        // Populate income data
                        if (data.income) {
                            document.getElementById('income1Rate').value = data.income.spouse1.rate || '';
                            document.getElementById('income1Frequency').value = data.income.spouse1.frequency || 'yearly';
                            document.getElementById('income1Hours').value = data.income.spouse1.hours || 40;
                            // Rental and business income fields removed
                            
                            document.getElementById('income2Rate').value = data.income.spouse2.rate || '';
                            document.getElementById('income2Frequency').value = data.income.spouse2.frequency || 'yearly';
                            document.getElementById('income2Hours').value = data.income.spouse2.hours || 40;
                            // Rental and business income fields removed
                        }
                        
                        // Populate insurance needs
                        if (data.insuranceNeeds) {
                            document.getElementById('finalExpenses').value = data.insuranceNeeds.finalExpenses || 15000;
                            document.getElementById('incomeReplacement').value = data.insuranceNeeds.incomeReplacement || 10;
                        }
                    }
                    
                    // Call the inline function
                    populateFormDataInline(data);
                    
                    // Update partner names after loading data
                    if (typeof updatePartnerNames === 'function') {
                        updatePartnerNames();
                    }
                    
                    // Update income displays
                    if (typeof updateIncomeDisplay === 'function') {
                        updateIncomeDisplay();
                    }
                    
                    alert('Data loaded successfully!');
                    
                } catch (error) {
                    alert('Error loading data: ' + error.message);
                    console.error('JSON parsing error:', error);
                }
            };
            
            // Handle file reading errors
            reader.onerror = function() {
                alert('Error reading file. Please try again.');
                console.error('FileReader error');
            };
            
            reader.readAsText(file);
        });
        
        /* // Added as per claude request to the better solution is to move this entire DOMContentLoaded event listener to the very end of the JavaScript code, 
        // right before the closing script tag (after all functions are defined).
        // Initialize event listeners after all functions are defined
        document.addEventListener('DOMContentLoaded', function() {
            // Set up file input event listener for loading data
            document.getElementById('fileInput').addEventListener('change', loadData);
            
            // Initialize conditional field visibility
            toggleDownsizeField();
            toggleRentField();
            
            // Initialize income display
            updateIncomeDisplay();
        }); */

    </script>
    
    <script>
        // Rest of the application code
        let charts = {};
        let currentScenario = 'registered';
        
        // Initialize blank charts when page loads
        function initializeBlankCharts() {
            initializeBlankProjectionChart();
            initializeBlankNetWorthChart();
            initializeBlankFinancialAnalysisCharts();
        }
        
        function initializeBlankProjectionChart() {
            const ctx = document.getElementById('projectionChart').getContext('2d');
            
            if (charts.projection) {
                charts.projection.destroy();
            }
            
            charts.projection = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#cccccc',
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return '$' + (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return '$' + (value / 1000).toFixed(0) + 'K';
                                    }
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: '#333'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#cccccc'
                            },
                            grid: {
                                color: '#333'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#cccccc'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Financial Projection - Calculate to View Data',
                            color: '#b19777',
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });
        }
        
        function initializeBlankNetWorthChart() {
            const ctx = document.getElementById('netWorthChart').getContext('2d');
            
            if (charts.netWorth) {
                charts.netWorth.destroy();
            }
            
            charts.netWorth = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: []
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#cccccc'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Net Worth Breakdown - Calculate to View Data',
                            color: '#b19777',
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });
        }
        
        function initializeBlankFinancialAnalysisCharts() {
            // Initialize blank versions of the financial analysis charts
            initializeBlankChart('cashFlowChart', 'bar', 'Monthly Cash Flow - Calculate to View Data');
            initializeBlankChart('insuranceChart', 'doughnut', 'Insurance Coverage - Calculate to View Data');
            initializeBlankChart('retirementChart', 'line', 'Retirement Projection - Calculate to View Data');
        }
        
        function initializeBlankChart(chartId, type, title) {
            const canvas = document.getElementById(chartId);
            if (!canvas) return; // Chart doesn't exist
            
            const ctx = canvas.getContext('2d');
            
            if (charts[chartId.replace('Chart', '')]) {
                charts[chartId.replace('Chart', '')].destroy();
            }
            
            const chartConfig = {
                type: type,
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#cccccc'
                            }
                        },
                        title: {
                            display: true,
                            text: title,
                            color: '#b19777',
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            };
            
            // Add scale configuration for non-doughnut charts
            if (type !== 'doughnut') {
                chartConfig.options.scales = {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#cccccc'
                        },
                        grid: {
                            color: '#333'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#cccccc'
                        },
                        grid: {
                            color: '#333'
                        }
                    }
                };
            }
            
            charts[chartId.replace('Chart', '')] = new Chart(ctx, chartConfig);
        }
        
        // Scenario switching
        // FIN Cell click handler for detailed view
        function showScenarioDetails(taxType, scenario) {
            if (!window.currentCalculations) return;
            
            const scenarioData = window.currentCalculations.scenarios[taxType][scenario];
            
            // Update summary cards with selected scenario
            document.getElementById('monthlySavingsNeeded').textContent = 
         '$' + scenarioData.monthlyNeeded.toLocaleString(undefined, {maximumFractionDigits: 0});
            
            // Highlight selected cell
            document.querySelectorAll('.fin-cell').forEach(cell => cell.classList.remove('selected'));
            document.getElementById(`fin-${taxType}-${scenario}`).classList.add('selected');
            
            // Update charts with selected scenario
            createProjectionChart(window.currentCalculations, taxType, scenario);
        }
        
        // Add new dependent row to the dependents list
        // Add new dependent row with same formatting as original row
        function addDependent() {
            const container = document.getElementById('dependentsList');
            const div = document.createElement('div');
            div.className = 'form-row-4';
            // Match the original row's 5-column grid layout
            div.style.gridTemplateColumns = '1fr 1fr 1fr 1fr 1fr';
            div.innerHTML = `
                <div class="form-group">
                    <label>Child Name:</label>
                    <input type="text" class="dependent-name" placeholder="Child's Name">
                </div>
                <div class="form-group">
                    <label>Date of Birth:</label>
                    <input type="text" class="dependent-dob" placeholder="YYYYMMDD" oninput="formatDateInput(this)">
                </div>
                <div class="form-group">
                    <label>Post-Secondary Start Age:</label>
                    <input type="number" class="dependent-edu-age" value="18" min="16" max="25">
                </div>
                <div class="form-group">
                    <label>Years of Study:</label>
                    <input type="number" class="dependent-study-years" value="4" min="1" max="8">
                </div>
                <div class="form-group">
                    <label>Annual Education Cost:</label>
                    <input type="text" class="dependent-edu-cost" value="$12,000.00" oninput="formatCurrency(this)" onblur="formatCurrencyComplete(this)">
                </div>
            `;
            container.appendChild(div);
        }
        
        function addGoal() {
            const container = document.getElementById('goalsList');
            const div = document.createElement('div');
            div.className = 'goal-item';
            div.innerHTML = `
                <input type="checkbox" class="goal-active">
                <select class="goal-type">
                    <option value="home">Home Purchase</option>
                    <option value="mortgage">Pay Off Mortgage</option>
                    <option value="education">Education Funding</option>
                    <option value="business">Start Business</option>
                    <option value="travel">Travel</option>
                    <option value="debt">Pay Off Debts</option>
                    <option value="parents">Aging Parents Support</option>
                    <option value="emergency">Emergency Fund</option>
                    <option value="other">Other</option>
                </select>
                <input type="number" class="goal-years" placeholder="Years Away" min="0" max="50">
                <input type="text" class="goal-amount" placeholder="$0.00" onchange="formatCurrency(this)"
                <select class="goal-frequency">
                    <option value="one-time">One-time</option>
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                </select>
            `;
            container.appendChild(div);
        }
        
        
        
        function addInsurance() {
            const container = document.getElementById('insuranceList');
            const div = document.createElement('div');
            div.className = 'form-row-4';
            div.innerHTML = `
                <div class="form-group">
                    <label>Policy Type:</label>
                    <select class="insurance-type">
                        <option value="term-life">Term Life</option>
                        <option value="whole-life">Whole Life</option>
                        <option value="universal-life">Universal Life</option>
                        <option value="disability">Disability</option>
                        <option value="critical-illness">Critical Illness</option>
                        <option value="health">Health/Extended Health</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Coverage Amount ($):</label>
                    <input type="text" class="insurance-amount" placeholder="$0.00" onchange="handleInsuranceChange(this)">
                </div>
                <div class="form-group">
                    <label>Annual Premium ($):</label>
                    <input type="text" class="insurance-premium" placeholder="$0.00" onchange="handleInsuranceChange(this)">
                </div>
                <div class="form-group">
                    <label>Term/Duration:</label>
                    <input type="text" class="insurance-term" placeholder="e.g., 20 years, Age 65">
                </div>
            `;
            container.appendChild(div);
        }
        
        // Calculate age from DOB (duplicate function - keeping for compatibility)
        function calculateAge(dob) {
            if (!dob) return 0;
            
            let dateToUse = dob;
            
            // If dob is in YYYYMMDD format (8 digits), convert to YYYY-MM-DD
            if (/^\d{8}$/.test(dob)) {
                const year = dob.substring(0, 4);
                const month = dob.substring(4, 6);
                const day = dob.substring(6, 8);
                dateToUse = `${year}-${month}-${day}`;
            }
            
            const today = new Date();
            const birth = new Date(dateToUse);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }
        
        // Calculate annual income from frequency
        function calculateAnnualIncome(rate, frequency, hours = 40) {
            if (!rate || rate <= 0) return 0;
            
            const multipliers = {
                'hourly': hours * 52,
                'weekly': 52,
                'biweekly': 26,
                'monthly': 12,
                'yearly': 1
            };
            return rate * (multipliers[frequency] || 1);
        }
        
        // Update income display with real-time calculations
        function updateIncomeDisplay() {
            try {
                // Partner 1 Income Calculation
                const rate1 = parseFloat(document.getElementById('income1Rate').value.replace(/[^0-9.]/g, '')) || 0;
                const frequency1 = document.getElementById('income1Frequency').value;
                const hours1 = parseFloat(document.getElementById('income1Hours').value) || 40;
                
                const annual1 = calculateAnnualIncome(rate1, frequency1, hours1);
                
                // Partner 2 Income Calculation
                const rate2 = parseFloat(document.getElementById('income2Rate').value.replace(/[^0-9.]/g, '')) || 0;
                const frequency2 = document.getElementById('income2Frequency').value;
                const hours2 = parseFloat(document.getElementById('income2Hours').value) || 40;
                
                const annual2 = calculateAnnualIncome(rate2, frequency2, hours2);
                
                // Calculate take-home hourly rates (regardless of frequency)
                const hoursPerWeek1 = hours1 || 40;
                const hoursPerWeek2 = hours2 || 40;
                const takeHomeHourly1 = annual1 > 0 ? annual1 / (hoursPerWeek1 * 52) : 0;
                const takeHomeHourly2 = annual2 > 0 ? annual2 / (hoursPerWeek2 * 52) : 0;
                
                // Update titles with calculated amounts and take-home hourly rate
                document.getElementById('partner1IncomeTitle').innerHTML = 
                    `💰 Partner 1 Income - $${annual1.toLocaleString()} per year` + 
                    (takeHomeHourly1 > 0 ? ` <span style="font-size: 0.8em; color: white; font-weight: normal;">($${takeHomeHourly1.toFixed(2)}/hour take-home)</span>` : '');
                    
                document.getElementById('partner2IncomeTitle').innerHTML = 
                    `💰 Partner 2 Income - $${annual2.toLocaleString()} per year` + 
                    (takeHomeHourly2 > 0 ? ` <span style="font-size: 0.8em; color: white; font-weight: normal;">($${takeHomeHourly2.toFixed(2)}/hour take-home)</span>` : '');
                    
            } catch (error) {
                console.error('Error updating income display:', error);
            }
        }
        
        // Main calculation function
        function calculateFinancialNeedsAnalysis() {
            // Check if data has been saved
            if (!window.dataSaved) {
                const confirmed = confirm(
                    'Please save your data before running the Financial Needs Analysis.\n\n' +
                    'This ensures you have a backup of your information and creates a baseline for your financial projections.\n\n' +
                    'Click OK to save now, or Cancel to go back and save manually.'
                );
                
                if (confirmed) {
                    try {
                        saveData();
                        // Set flag to indicate data has been saved
                        window.dataSaved = true;
                    } catch (error) {
                        alert('Failed to save data: ' + error.message + '\n\nPlease save manually before calculating.');
                        return;
                    }
                } else {
                    return; // User cancelled, don't proceed with calculation
                }
            }
            
            try {
                const data = collectAllData();
                const calculations = performCalculations(data);
                displayResults(calculations);
            } catch (error) {
                alert('Error in calculations: ' + error.message);
                console.error(error);
            }
        }
        
        function collectAllData() {
            // Collect family data
            const family = {
                spouse1: {
                    name: document.getElementById('spouse1Name').value,
                    dob: document.getElementById('spouse1DOB').value,
                    gender: document.getElementById('spouse1Gender').value,
                    retireAge: parseInt(document.getElementById('spouse1RetireAge').value) || 65,
                    lifeExpectancy: parseInt(document.getElementById('spouse1LifeExpectancy').value) || 85,
                    email: document.getElementById('spouse1Email').value,
                    phone: document.getElementById('spouse1Phone').value,
                    age: calculateAge(document.getElementById('spouse1DOB').value)
                },
                spouse2: {
                    name: document.getElementById('spouse2Name').value,
                    dob: document.getElementById('spouse2DOB').value,
                    gender: document.getElementById('spouse2Gender').value,
                    retireAge: parseInt(document.getElementById('spouse2RetireAge').value) || 65,
                    lifeExpectancy: parseInt(document.getElementById('spouse2LifeExpectancy').value) || 85,
                    email: document.getElementById('spouse2Email').value,
                    phone: document.getElementById('spouse2Phone').value,
                    age: calculateAge(document.getElementById('spouse2DOB').value)
                },
                dependents: []
            };
            
            // Collect dependents
            document.querySelectorAll('#dependentsList .form-row-4').forEach(row => {
                const name = row.querySelector('.dependent-name').value;
                const dob = row.querySelector('.dependent-dob').value;
                const eduAge = parseInt(row.querySelector('.dependent-edu-age').value) || 18;
                const studyYears = parseInt(row.querySelector('.dependent-study-years').value) || 4;
                const eduCost = parseFloat(row.querySelector('.dependent-edu-cost').value.replace(/[^0-9.]/g, '')) || 12000;
                
                if (name && dob) {
                    family.dependents.push({
                        name, dob, eduAge, studyYears, eduCost,
                        age: calculateAge(dob)
                    });
                }
            });
            
            // Collect assumptions
            const assumptions = {
                inflationRate: parsePercentageValue(document.getElementById('inflationRate').value) / 100 || 0.028,
                preRetireRate: parsePercentageValue(document.getElementById('preRetireRate').value) / 100 || 0.065,
                postRetireRate: parsePercentageValue(document.getElementById('postRetireRate').value) / 100 || 0.04,
                survivorYears: parseInt(document.getElementById('survivorYears').value) || 5,
                retirementIncome: parseFloat(document.getElementById('retirementIncome').value) || 0,
                currentHousing: document.getElementById('currentHousing').value,
                retirementHousing: document.getElementById('retirementHousing').value,
                downsizeIntent: document.getElementById('downsizeIntent').value === 'yes',
                retirementRent: parseFloat(document.getElementById('retirementRent').value.replace(/[^0-9.]/g, '')) || 2200,
                cpp1: parseFloat(document.getElementById('cpp1Monthly').value.replace(/[^0-9.]/g, '')) || 758,
                oas1: parseFloat(document.getElementById('oas1Monthly').value.replace(/[^0-9.]/g, '')) || 713,
                cpp2: parseFloat(document.getElementById('cpp2Monthly').value.replace(/[^0-9.]/g, '')) || 758,
                oas2: parseFloat(document.getElementById('oas2Monthly').value.replace(/[^0-9.]/g, '')) || 713,
                registeredTaxRate: parsePercentageValue(document.getElementById('registeredTaxRate').value) / 100 || 0.25,
                blendedTaxRate: parseFloat(document.getElementById('blendedTaxRate').value) / 100 || 0.15
            };
            
            // Collect goals
            const goals = [];
            document.querySelectorAll('.goal-item').forEach(item => {
                const active = item.querySelector('.goal-active').checked;
                const type = item.querySelector('.goal-type').value;
                const years = parseInt(item.querySelector('.goal-years').value) || 0;
                const amount = parseFloat(item.querySelector('.goal-amount').value.replace(/[^0-9.]/g, '')) || 0;
                const frequency = item.querySelector('.goal-frequency').value;
                
                if (active && amount > 0) {
                    goals.push({ type, years, amount, frequency });
                }
            });
            
            // Collect income
            const income = {
                spouse1: {
                    rate: parseFloat(document.getElementById('income1Rate').value.replace(/[^0-9.]/g, '')) || 0,
                    frequency: document.getElementById('income1Frequency').value,
                    hours: parseFloat(document.getElementById('income1Hours').value) || 40,
                    rental: 0,
                    business: 0
                },
                spouse2: {
                    rate: parseFloat(document.getElementById('income2Rate').value.replace(/[^0-9.]/g, '')) || 0,
                    frequency: document.getElementById('income2Frequency').value,
                    hours: parseFloat(document.getElementById('income2Hours').value) || 40,
                    rental: 0,
                    business: 0
                }
            };
            
            // Calculate total annual incomes
            income.spouse1.annual = calculateAnnualIncome(income.spouse1.rate, income.spouse1.frequency, income.spouse1.hours) + 
                                   (income.spouse1.rental * 12) + (income.spouse1.business * 12);
            income.spouse2.annual = calculateAnnualIncome(income.spouse2.rate, income.spouse2.frequency, income.spouse2.hours) + 
                                   (income.spouse2.rental * 12) + (income.spouse2.business * 12);
            
            // Collect assets (both liquid and fixed)
            const assets = [];
            document.querySelectorAll('.asset-item').forEach(item => {
                const type = item.querySelector('.asset-type').value;
                const valueStr = item.querySelector('.asset-value').value.replace(/[^0-9.]/g, '');
                const value = parseFloat(valueStr) || 0;
                const growthStr = item.querySelector('.asset-growth').value.replace(/[^0-9.]/g, '');
                const growth = parseFloat(growthStr) / 100 || 0.06;
                const notes = item.querySelector('.asset-notes').value;
                
                // Determine if liquid or fixed asset
                const isLiquid = item.classList.contains('liquid-asset');
                const assetCategory = isLiquid ? 'liquid' : 'fixed';
                
                if (value > 0) {
                    assets.push({ type, value, growth, notes, category: assetCategory });
                }
            });
            
            // Collect liabilities
            const liabilities = [];
            
            // Collect mortgages
            document.querySelectorAll('.mortgage-item').forEach(item => {
                const property = item.querySelector('.mortgage-property').value;
                const originalStr = item.querySelector('.mortgage-original').value.replace(/[^0-9.]/g, '');
                const original = parseFloat(originalStr) || 0;
                const balanceStr = item.querySelector('.mortgage-balance').value.replace(/[^0-9.]/g, '');
                const balance = parseFloat(balanceStr) || 0;
                const rate = parseFloat(item.querySelector('.mortgage-rate').value) / 100 || 0;
                const term = parseInt(item.querySelector('.mortgage-term').value) || 0;
                const paymentStr = item.querySelector('.mortgage-payment').value.replace(/[^0-9.]/g, '');
                const payment = parseFloat(paymentStr) || 0;
                const maturity = item.querySelector('.mortgage-maturity').value;
                
                if (balance > 0) {
                    liabilities.push({ type: 'mortgage-' + property, original, balance, rate, term, payment, maturity });
                }
            });
            
            // Collect other debts
            document.querySelectorAll('.liability-item').forEach(item => {
                const type = item.querySelector('.liability-type').value;
                const balanceStr = item.querySelector('.liability-balance').value.replace(/[^0-9.]/g, '');
                const balance = parseFloat(balanceStr) || 0;
                const rate = parseFloat(item.querySelector('.liability-rate').value) / 100 || 0;
                const paymentStr = item.querySelector('.liability-payment').value.replace(/[^0-9.]/g, '');
                const payment = parseFloat(paymentStr) || 0;
                
                if (balance > 0) {
                    liabilities.push({ type, balance, rate, payment });
                }
            });
            
            // Collect insurance
            const insurance = [];
            document.querySelectorAll('#insuranceList .insurance-item').forEach(row => {
                const type = row.querySelector('.insurance-type').value;
                const amountStr = row.querySelector('.insurance-amount').value.replace(/[^0-9.]/g, '');
                const amount = parseFloat(amountStr) || 0;
                const premiumStr = row.querySelector('.insurance-premium').value.replace(/[^0-9.]/g, '');
                const premium = parseFloat(premiumStr) || 0;
                const term = row.querySelector('.insurance-term').value;
                const owner = row.querySelector('.insurance-owner').value;
                const beneficiary = row.querySelector('.insurance-beneficiary').value;
                
                if (amount > 0) {
                    insurance.push({ type, amount, premium, term, owner, beneficiary });
                }
            });
            
            const finalExpenses1Str = document.getElementById('finalExpenses1').value.replace(/[^0-9.]/g, '');
            const finalExpenses2Str = document.getElementById('finalExpenses2').value.replace(/[^0-9.]/g, '');
            const insuranceNeeds = {
                partner1: {
                    finalExpenses: parseFloat(finalExpenses1Str) || 15000,
                    incomeReplacement: parseInt(document.getElementById('incomeReplacement1').value) || 10
                },
                partner2: {
                    finalExpenses: parseFloat(finalExpenses2Str) || 15000,
                    incomeReplacement: parseInt(document.getElementById('incomeReplacement2').value) || 10
                },
                // Backward compatibility
                finalExpenses: parseFloat(finalExpenses1Str) || 15000,
                incomeReplacement: parseInt(document.getElementById('incomeReplacement1').value) || 10
            };
            
            return { family, assumptions, goals, income, assets, liabilities, insurance, insuranceNeeds };
        }
        
        function performCalculations(data) {
            const calculations = {};
            
            // Calculate basic retirement timing
            const earliestRetirement = Math.min(
                data.family.spouse1.retireAge - data.family.spouse1.age,
                data.family.spouse2.name ? data.family.spouse2.retireAge - data.family.spouse2.age : Infinity
            );
            const latestLifeExpectancy = Math.max(
                data.family.spouse1.lifeExpectancy,
                data.family.spouse2.name ? data.family.spouse2.lifeExpectancy : 0
            );
            const latestRetirementAge = Math.max(
                data.family.spouse1.retireAge,
                data.family.spouse2.name ? data.family.spouse2.retireAge : 0
            );
            
            calculations.yearsToRetirement = Math.max(0, earliestRetirement);
            calculations.retirementLength = latestLifeExpectancy - latestRetirementAge;
            
            // Calculate current net worth
            const totalAssets = data.assets.reduce((sum, asset) => sum + asset.value, 0);
            const totalLiabilities = data.liabilities.reduce((sum, liability) => sum + liability.balance, 0);
            calculations.currentNetWorth = totalAssets - totalLiabilities;
            
            // Calculate total annual income
            calculations.totalAnnualIncome = data.income.spouse1.annual + data.income.spouse2.annual;
            
            // Calculate government benefits at retirement
            const govBenefits = (data.assumptions.cpp1 + data.assumptions.oas1 + 
                               data.assumptions.cpp2 + data.assumptions.oas2) * 12;
            
            // Calculate required retirement income
            const requiredAnnualIncome = data.assumptions.retirementIncome * 12;
            const incomeShortfall = Math.max(0, requiredAnnualIncome - govBenefits);
            calculations.monthlyShortfall = incomeShortfall / 12;
            
            // Calculate education costs for dependents - smart calculation
            let totalEducationCosts = 0;
            data.family.dependents.forEach(dependent => {
                totalEducationCosts += calculateSmartEducationFunding(dependent, data.assumptions.inflationRate);
            });
            
            // Calculate goal costs
            let totalGoalCosts = 0;
            data.goals.forEach(goal => {
                const inflatedAmount = goal.amount * Math.pow(1 + data.assumptions.inflationRate, goal.years);
                if (goal.frequency === 'one-time') {
                    totalGoalCosts += inflatedAmount;
                } else if (goal.frequency === 'monthly') {
                    totalGoalCosts += inflatedAmount * 12 * 20; // Assume 20 years
                } else if (goal.frequency === 'yearly') {
                    totalGoalCosts += inflatedAmount * 20; // Assume 20 years
                }
            });
            
            // Calculate FIN# for 3x3 matrix (3 tax scenarios x 3 drawdown approaches)
            calculations.scenarios = {};
            
            // Tax-adjusted income shortfall calculations
            const registeredIncomeShortfall = incomeShortfall / (1 - data.assumptions.registeredTaxRate);
            const blendedIncomeShortfall = incomeShortfall / (1 - data.assumptions.blendedTaxRate);
            const nonTaxIncomeShortfall = incomeShortfall; // TFSA and PTS - no tax on withdrawal
            
            // Base costs (one-time amounts)
            const baseEducationCosts = totalEducationCosts;
            const baseGoalCosts = totalGoalCosts;
            
            // Calculate for each tax scenario and drawdown approach
            const taxScenarios = [
                { key: 'registered', shortfall: registeredIncomeShortfall, taxRate: data.assumptions.registeredTaxRate },
                { key: 'blended', shortfall: blendedIncomeShortfall, taxRate: data.assumptions.blendedTaxRate },
                { key: 'nontax', shortfall: nonTaxIncomeShortfall, taxRate: 0 }
            ];
            
            taxScenarios.forEach(tax => {
                calculations.scenarios[tax.key] = {};
                
                // 1. Principal Maintenance (Conservative 3.5% withdrawal rate - never depletes)
                const preserveWithdrawalRate = 0.035;
                const preserveFIN = (tax.shortfall + baseEducationCosts/20 + baseGoalCosts/20) / preserveWithdrawalRate;
                calculations.scenarios[tax.key].preserve = {
                    finNumber: preserveFIN,
                    monthlyNeeded: calculateMonthlyContribution(
                        Math.max(0, preserveFIN - totalAssets),
                        calculations.yearsToRetirement,
                        data.assumptions.preRetireRate
                    ),
                    withdrawalRate: preserveWithdrawalRate,
                    description: 'Principal Maintenance'
                };
                
                // 2. Drawdown + 10 Years Buffer (Portfolio lasts to life expectancy + 10 years)
                const bufferYears = calculations.retirementLength + 10;
                const bufferPV = calculatePresentValueAnnuity(
                    tax.shortfall / 12, 
                    data.assumptions.postRetireRate / 12, 
                    bufferYears * 12
                );
                const bufferFIN = bufferPV + baseEducationCosts + baseGoalCosts;
                calculations.scenarios[tax.key].buffer = {
                    finNumber: bufferFIN,
                    monthlyNeeded: calculateMonthlyContribution(
                        Math.max(0, bufferFIN - totalAssets),
                        calculations.yearsToRetirement,
                        data.assumptions.preRetireRate
                    ),
                    retirementYears: bufferYears,
                    description: 'Drawdown + 10 Years'
                };
                
                // 3. Drawdown to Lifespan (Portfolio depletes exactly at life expectancy)
                const lifespanYears = calculations.retirementLength;
                const depletePV = calculatePresentValueAnnuity(
                    tax.shortfall / 12, 
                    data.assumptions.postRetireRate / 12, 
                    lifespanYears * 12
                );
                const depleteFIN = depletePV + baseEducationCosts + baseGoalCosts;
                calculations.scenarios[tax.key].deplete = {
                    finNumber: depleteFIN,
                    monthlyNeeded: calculateMonthlyContribution(
                        Math.max(0, depleteFIN - totalAssets),
                        calculations.yearsToRetirement,
                        data.assumptions.preRetireRate
                    ),
                    retirementYears: lifespanYears,
                    description: 'Drawdown to Lifespan'
                };
            });
            
            // Legacy scenarios for backward compatibility
            calculations.scenarios.preserve = calculations.scenarios.registered;
            calculations.scenarios.deplete = calculations.scenarios.blended;
            
            // Calculate insurance needs (DIME method)
            const debtTotal = totalLiabilities;
            const incomeNeeds = calculations.totalAnnualIncome * data.insuranceNeeds.incomeReplacement;
            const mortgageDebt = debtTotal;
            const educationFund = totalEducationCosts;
            
            calculations.insurance = {
                totalNeed: data.insuranceNeeds.finalExpenses + incomeNeeds + mortgageDebt + educationFund,
                currentCoverage: data.insurance.reduce((sum, policy) => {
                    return policy.type.includes('life') ? sum + policy.amount : sum;
                }, 0),
                annualPremiums: data.insurance.reduce((sum, policy) => sum + policy.premium, 0)
            };
            calculations.insurance.gap = Math.max(0, calculations.insurance.totalNeed - calculations.insurance.currentCoverage);
            
            // Update insurance fields
            document.getElementById('mortgageDebt').value = mortgageDebt;
            document.getElementById('educationFund').value = educationFund;
            
            return calculations;
        }
        
        function calculateMonthlyContribution(futureValue, years, annualRate) {
            if (futureValue <= 0 || years <= 0) return 0;
            
            const monthlyRate = annualRate / 12;
            const months = years * 12;
            
            if (monthlyRate === 0) {
                return futureValue / months;
            }
            
            return futureValue / (((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate));
        }
        
        function calculatePresentValueAnnuity(payment, rate, periods) {
            if (rate === 0) {
                return payment * periods;
            }
            
            return payment * ((1 - Math.pow(1 + rate, -periods)) / rate);
        }
        
        function displayResults(calculations) {
            // Show the calculation results section
            document.getElementById('calculationResults').style.display = 'block';
            
            // Update 3x3 FIN Matrix
            const scenarios = ['preserve', 'buffer', 'deplete'];
            const taxTypes = ['registered', 'blended', 'nontax'];
            
            taxTypes.forEach(taxType => {
                scenarios.forEach(scenario => {
                    const cellId = `fin-${taxType}-${scenario}`;
                    const cell = document.getElementById(cellId);
                    if (cell && calculations.scenarios[taxType] && calculations.scenarios[taxType][scenario]) {
                        const finAmount = calculations.scenarios[taxType][scenario].finNumber;
                        const monthlyAmount = calculations.scenarios[taxType][scenario].monthlyNeeded;
                        
                        cell.querySelector('.fin-amount').textContent = 
                            '$' + finAmount.toLocaleString(undefined, {maximumFractionDigits: 0});
                        cell.querySelector('.monthly-amount').textContent = 
                            '$' + monthlyAmount.toLocaleString(undefined, {maximumFractionDigits: 0}) + '/month';
                        
                        // Add click handler to cell
                        cell.onclick = () => showScenarioDetails(taxType, scenario);
                    }
                });
            });
            
            // Update summary cards
            document.getElementById('yearsToRetirement').textContent = calculations.yearsToRetirement;
            document.getElementById('retirementLength').textContent = calculations.retirementLength;
            document.getElementById('monthlyShortfall').textContent = 
         '$' + calculations.monthlyShortfall.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('monthlySavingsNeeded').textContent = 
         '$' + calculations.scenarios.registered.preserve.monthlyNeeded.toLocaleString(undefined, {maximumFractionDigits: 0});
            
            // Update insurance analysis
            document.getElementById('totalInsuranceNeed').textContent = 
         '$' + calculations.insurance.totalNeed.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('currentInsuranceCoverage').textContent = 
         '$' + calculations.insurance.currentCoverage.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('insuranceGap').textContent = 
         '$' + calculations.insurance.gap.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('annualPremiums').textContent = 
         '$' + calculations.insurance.annualPremiums.toLocaleString(undefined, {maximumFractionDigits: 0});
            
            // Create charts with conservative scenario (registered preserve)
            createProjectionChart(calculations);
            createNetWorthChart(calculations);
            createFinancialAnalysisCharts(calculations);
            
            // Store calculations globally
            window.currentCalculations = calculations;
        }
        
        // Legacy function for backward compatibility
        function updateScenarioDisplay() {
            if (!window.currentCalculations) return;
            
            // Default to conservative scenario for charts
            const scenario = window.currentCalculations.scenarios.registered.preserve;
            
            // Update the summary cards with conservative scenario
            document.getElementById('monthlySavingsNeeded').textContent = 
         '$' + scenario.monthlyNeeded.toLocaleString(undefined, {maximumFractionDigits: 0});
            
            // Update charts with conservative scenario
            createProjectionChart(window.currentCalculations, 'registered', 'preserve');
        }
        
        function createProjectionChart(calculations, taxType = 'registered', scenarioType = 'preserve') {
            const ctx = document.getElementById('projectionChart').getContext('2d');
            
            if (charts.projection) {
                charts.projection.destroy();
            }
            
            const years = [];
            const currentPath = [];
            const targetPath = [];
            const requiredPath = [];
            
            const scenario = calculations.scenarios[taxType][scenarioType];
            const currentAssets = calculations.currentNetWorth;
            const monthlyContribution = scenario.monthlyNeeded;
            
            // Collect data for assumptions
            const data = collectAllData();
            const preRetireRate = data.assumptions.preRetireRate;
            
            for (let year = 0; year <= calculations.yearsToRetirement + 10; year++) {
                years.push(year);
                
                // Current assets growth with no additional contributions
                currentPath.push(Math.max(0, currentAssets * Math.pow(1 + preRetireRate, year)));
                
                // Target amount (FIN#)
                if (year <= calculations.yearsToRetirement) {
                    targetPath.push(scenario.finNumber);
                } else {
                    // Show depletion in retirement for deplete scenarios
                    if (scenarioType === 'deplete' || scenarioType === 'buffer') {
                        const yearsInRetirement = year - calculations.yearsToRetirement;
                        const retirementYears = scenario.retirementYears || calculations.retirementLength;
                        if (yearsInRetirement < retirementYears) {
                            const remaining = scenario.finNumber * Math.pow(1 + data.assumptions.postRetireRate, yearsInRetirement) - 
                                            (calculations.monthlyShortfall * 12 * yearsInRetirement);
                            targetPath.push(Math.max(0, remaining));
                        } else {
                            targetPath.push(0); // Portfolio depleted
                        }
                    } else {
                        targetPath.push(scenario.finNumber); // Principal maintenance
                    }
                }
                
                // Required path with monthly contributions
                if (year <= calculations.yearsToRetirement) {
                    if (monthlyContribution > 0) {
                        const monthlyRate = preRetireRate / 12;
                        const months = year * 12;
                        const futureValueContributions = monthlyContribution * (((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate));
                        requiredPath.push(currentAssets * Math.pow(1 + preRetireRate, year) + futureValueContributions);
                    } else {
                        requiredPath.push(currentAssets * Math.pow(1 + preRetireRate, year));
                    }
                } else {
                    // Continue the path in retirement
                    const retirementValue = requiredPath[calculations.yearsToRetirement];
                    const yearsInRetirement = year - calculations.yearsToRetirement;
                    if (scenarioType === 'preserve') {
                        requiredPath.push(retirementValue);
                    } else {
                        const retirementYears = scenario.retirementYears || calculations.retirementLength;
                        if (yearsInRetirement < retirementYears) {
                            const remaining = retirementValue * Math.pow(1 + data.assumptions.postRetireRate, yearsInRetirement) - 
                                            (calculations.monthlyShortfall * 12 * yearsInRetirement);
                            requiredPath.push(Math.max(0, remaining));
                        } else {
                            requiredPath.push(0);
                        }
                    }
                }
            }
            
            charts.projection = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years.map(y => y === 0 ? 'Today' : `Year ${y}`),
                    datasets: [
                        {
                            label: 'Current Path (No Additional Savings)',
                            data: currentPath,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: `${scenario.description} Target`,
                            data: targetPath,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            fill: false,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'Projected with Required Savings',
                            data: requiredPath,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Financial Projection - ${scenario.description} (${taxType.charAt(0).toUpperCase() + taxType.slice(1)} Tax)`
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return 
         '$' + (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return 
         '$' + (value / 1000).toFixed(0) + 'K';
                                    }
                                    return 
         '$' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: function(context) {
                                    return context.tick.value === calculations.yearsToRetirement ? '#667eea' : '#e0e0e0';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createNetWorthChart(calculations) {
            const ctx = document.getElementById('netWorthChart').getContext('2d');
            
            if (charts.netWorth) {
                charts.netWorth.destroy();
            }
            
            const data = collectAllData();
            const ages = [];
            const netWorthData = [];
            const assetsData = [];
            const liabilitiesData = [];
            
            const startAge = Math.min(data.family.spouse1.age, data.family.spouse2.age || 100);
            const endAge = Math.max(data.family.spouse1.lifeExpectancy, data.family.spouse2.lifeExpectancy || 0);
            
            for (let age = startAge; age <= endAge; age += 5) {
                ages.push(age);
                
                const yearsFromNow = age - startAge;
                
                // Calculate assets growth
                let totalAssets = 0;
                data.assets.forEach(asset => {
                    totalAssets += asset.value * Math.pow(1 + asset.growth, yearsFromNow);
                });
                
                // Add savings if still working
                if (age < Math.min(data.family.spouse1.retireAge, data.family.spouse2.retireAge || 100)) {
                    const scenario = calculations.scenarios.registered.preserve;
                    const monthlyContribution = scenario.monthlyNeeded;
                    const monthlyRate = data.assumptions.preRetireRate / 12;
                    const months = yearsFromNow * 12;
                    if (monthlyContribution > 0 && months > 0) {
                        const futureValueContributions = monthlyContribution * (((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate));
                        totalAssets += futureValueContributions;
                    }
                }
                
                // Calculate liabilities reduction
                let totalLiabilities = 0;
                data.liabilities.forEach(liability => {
                    // Simplified: assume liabilities decrease over time
                    const remainingBalance = Math.max(0, liability.balance - (liability.payment * 12 * yearsFromNow));
                    totalLiabilities += remainingBalance;
                });
                
                assetsData.push(totalAssets);
                liabilitiesData.push(totalLiabilities);
                netWorthData.push(totalAssets - totalLiabilities);
            }
            
            charts.netWorth = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ages.map(age => `Age ${age}`),
                    datasets: [
                        {
                            label: 'Total Assets',
                            data: assetsData,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            fill: '+1'
                        },
                        {
                            label: 'Total Liabilities',
                            data: liabilitiesData,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: 'origin'
                        },
                        {
                            label: 'Net Worth',
                            data: netWorthData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            fill: false,
                            tension: 0.1,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Net Worth Projection by Age'
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return 
         '$' + (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return 
         '$' + (value / 1000).toFixed(0) + 'K';
                                    }
                                    return 
         '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
        function createDimeCharts() {
            const data = collectAllData();
            const inflationRate = data.assumptions.inflationRate || 0.03;
            const discountRate = data.assumptions.postRetireRate || 0.04;
            
            // Create charts for both partners
            ['partner1', 'partner2'].forEach(partner => {
                const isPartner1 = partner === 'partner1';
                const partnerData = isPartner1 ? data.family.spouse1 : data.family.spouse2;
                const partnerIncome = isPartner1 ? data.income.spouse1.annual : data.income.spouse2.annual;
                
                // Skip if partner doesn't exist
                if (!partnerData.name && !isPartner1) return;
                
                // Update chart title with partner name
                const titleElement = document.getElementById(`${partner}DimeChartTitle`);
                if (titleElement) {
                    titleElement.textContent = `${partnerData.name || `Partner ${isPartner1 ? '1' : '2'}`} DIME Analysis`;
                }
                
                const ctx = document.getElementById(`${partner}DimeChart`);
                if (!ctx) return;
                
                // Destroy existing chart
                if (charts[`${partner}Dime`]) {
                    charts[`${partner}Dime`].destroy();
                }
                
                // Calculate DIME components over time
                const ages = [];
                const dimeData = [];
                const termOptions = [
                    { years: 10, color: '#e74c3c', label: '10-Year Term' },
                    { years: 20, color: '#f39c12', label: '20-Year Term' },
                    { years: 30, color: '#3498db', label: '30-Year Term' },
                    { years: 100 - partnerData.age, color: '#27ae60', label: 'To Age 100' }
                ];
                
                // Create datasets for each term option
                const datasets = termOptions.map(term => ({
                    label: term.label,
                    data: [],
                    borderColor: term.color,
                    backgroundColor: term.color + '20',
                    fill: false,
                    stepped: true,
                    tension: 0
                }));
                
                // Calculate data points from current age to retirement
                const currentAge = partnerData.age;
                const retirementAge = partnerData.retireAge || 65;
                
                for (let age = currentAge; age <= Math.min(100, retirementAge + 5); age++) {
                    ages.push(age);
                    
                    // Calculate DIME components at this age
                    const yearsToRetirement = Math.max(0, retirementAge - age);
                    
                    // D - Final expenses (constant)
                    const finalExpensesId = isPartner1 ? 'finalExpenses1' : 'finalExpenses2';
                    const finalExpensesStr = document.getElementById(finalExpensesId)?.value.replace(/[^0-9.]/g, '') || '15000';
                    const D = parseFloat(finalExpensesStr) || 15000;
                    
                    // I - Income replacement (decreases as retirement approaches)
                    const incomeReplacementId = isPartner1 ? 'incomeReplacement1' : 'incomeReplacement2';
                    const incomeReplacementYears = parseInt(document.getElementById(incomeReplacementId)?.value) || 10;
                    
                    let I = 0;
                    if (yearsToRetirement > 0 && partnerIncome > 0) {
                        const effectiveYears = Math.min(incomeReplacementYears, yearsToRetirement);
                        if (Math.abs(discountRate - inflationRate) < 0.0001) {
                            I = partnerIncome * effectiveYears * Math.pow(1 + inflationRate, effectiveYears / 2);
                        } else {
                            const growthFactor = 1 + inflationRate;
                            const discountFactor = 1 + discountRate;
                            I = partnerIncome * (1 - Math.pow(growthFactor / discountFactor, effectiveYears)) / (discountRate - inflationRate);
                        }
                    }
                    
                    // M - Mortgage/Debt (decreases over time as debts are paid)
                    const totalLiabilities = data.liabilities.reduce((sum, liability) => {
                        // Assume debts are paid down over time
                        const yearsFromNow = age - currentAge;
                        const remainingBalance = liability.balance * Math.max(0, 1 - (yearsFromNow * 0.05)); // 5% reduction per year
                        return sum + remainingBalance;
                    }, 0);
                    const M = totalLiabilities;
                    
                    // E - Education fund (decreases as children age)
                    let E = 0;
                    data.family.dependents.forEach(dependent => {
                        const childAgeAtTime = dependent.age + (age - currentAge);
                        if (childAgeAtTime < (dependent.eduAge || 18) + (dependent.studyYears || 4)) {
                            E += calculateSmartEducationFunding({
                                ...dependent,
                                age: childAgeAtTime
                            }, inflationRate);
                        }
                    });
                    
                    const totalDime = D + I + M + E;
                    
                    // For each term option, calculate coverage needed
                    termOptions.forEach((term, index) => {
                        let coverage = 0;
                        const yearsFromStart = age - currentAge;
                        
                        if (yearsFromStart < term.years) {
                            // Still within term period
                            coverage = totalDime;
                        } else {
                            // Term expired, no coverage
                            coverage = 0;
                        }
                        
                        datasets[index].data.push(coverage);
                    });
                }
                
                // Create the chart
                charts[`${partner}Dime`] = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ages,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `Insurance Coverage Requirements by Age`,
                                color: '#b19777'
                            },
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    color: '#cccccc',
                                    usePointStyle: true
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Age',
                                    color: '#cccccc'
                                },
                                ticks: {
                                    color: '#cccccc'
                                },
                                grid: {
                                    color: '#555'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Insurance Coverage Needed',
                                    color: '#cccccc'
                                },
                                ticks: {
                                    color: '#cccccc',
                                    callback: function(value) {
                                        if (value >= 1000000) {
                                            return '$' + (value / 1000000).toFixed(1) + 'M';
                                        } else if (value >= 1000) {
                                            return '$' + (value / 1000).toFixed(0) + 'K';
                                        }
                                        return '$' + value.toLocaleString();
                                    }
                                },
                                grid: {
                                    color: '#555'
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            });
        }
        
        // Save and Load Functions (duplicate removed - function moved earlier in file)
        
        // Load saved data from JSON file and populate all form fields
        function loadData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    // populateFormData(data); removed as per claude
                    if (typeof populateFormData === 'function') {
                        populateFormData(data);
                    } else {
                        console.error('populateFormData function not defined yet');
                    }
                    // Update partner names after loading
                    updatePartnerNames();
                    // Reset save flag since loaded data may have changes
                    window.dataSaved = false;
                    alert('Data loaded successfully!');
                } catch (error) {
                    alert('Error loading data: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // Populate all form fields with data from loaded JSON file
        function populateFormData(data) {
            // Populate family data
            if (data.family) {
                document.getElementById('spouse1Name').value = data.family.spouse1.name || '';
                document.getElementById('spouse1DOB').value = data.family.spouse1.dob || '';
                document.getElementById('spouse1Gender').value = data.family.spouse1.gender || '';
                document.getElementById('spouse1RetireAge').value = data.family.spouse1.retireAge || 65;
                document.getElementById('spouse1LifeExpectancy').value = data.family.spouse1.lifeExpectancy || 85;
                document.getElementById('spouse1Email').value = data.family.spouse1.email || '';
                document.getElementById('spouse1Phone').value = data.family.spouse1.phone || '';
                
                document.getElementById('spouse2Name').value = data.family.spouse2.name || '';
                document.getElementById('spouse2DOB').value = data.family.spouse2.dob || '';
                document.getElementById('spouse2Gender').value = data.family.spouse2.gender || '';
                document.getElementById('spouse2RetireAge').value = data.family.spouse2.retireAge || 65;
                document.getElementById('spouse2LifeExpectancy').value = data.family.spouse2.lifeExpectancy || 85;
                document.getElementById('spouse2Email').value = data.family.spouse2.email || '';
                document.getElementById('spouse2Phone').value = data.family.spouse2.phone || '';
            }
            
            // Populate assumptions data
            if (data.assumptions) {
                document.getElementById('inflationRate').value = ((data.assumptions.inflationRate * 100).toFixed(2) || 2.8) + '%';
                document.getElementById('preRetireRate').value = ((data.assumptions.preRetireRate * 100).toFixed(2) || 6.5) + '%';
                document.getElementById('postRetireRate').value = ((data.assumptions.postRetireRate * 100).toFixed(2) || 4.0) + '%';
                document.getElementById('retirementIncomePercent').value = ((data.assumptions.retirementIncomePercent * 100).toFixed(2) || 70) + '%';
                document.getElementById('widowReduction').value = ((data.assumptions.widowReduction * 100).toFixed(2) || 70) + '%';
                document.getElementById('currentHousing').value = data.assumptions.currentHousing || 'own';
                document.getElementById('retirementHousing').value = data.assumptions.retirementHousing || 'own';
                document.getElementById('downsizeIntent').value = data.assumptions.downsizeIntent ? 'yes' : 'no';
                document.getElementById('downsizeValue').value = '$' + (data.assumptions.downsizeValue || 0).toLocaleString();
                document.getElementById('retirementRent').value = '$' + (data.assumptions.retirementRent || 2200).toLocaleString();
                document.getElementById('cpp1Monthly').value = '$' + (data.assumptions.cpp1 || 758).toLocaleString();
                document.getElementById('oas1Monthly').value = '$' + (data.assumptions.oas1 || 713).toLocaleString();
                document.getElementById('cpp2Monthly').value = '$' + (data.assumptions.cpp2 || 758).toLocaleString();
                document.getElementById('oas2Monthly').value = '$' + (data.assumptions.oas2 || 713).toLocaleString();
                
                // Update conditional field visibility
                toggleDownsizeField();
                toggleRentField();
            }
            
            // Populate income data
            if (data.income) {
                document.getElementById('income1Rate').value = data.income.spouse1.rate || '';
                document.getElementById('income1Frequency').value = data.income.spouse1.frequency || 'yearly';
                document.getElementById('income1Hours').value = data.income.spouse1.hours || 40;
                // Rental and business income fields removed
                
                document.getElementById('income2Rate').value = data.income.spouse2.rate || '';
                document.getElementById('income2Frequency').value = data.income.spouse2.frequency || 'yearly';
                document.getElementById('income2Hours').value = data.income.spouse2.hours || 40;
                // Rental and business income fields removed
                
                // Populate other income sources
                if (data.income.otherSources && data.income.otherSources.length > 0) {
                    data.income.otherSources.forEach((source, index) => {
                        if (index > 0) addIncomeSource();
                        const containers = document.querySelectorAll('.income-item');
                        const container = containers[index];
                        if (container) {
                            container.querySelector('.income-type').value = source.type || 'rental';
                            container.querySelector('.income-amount').value = '$' + (source.amount || 0).toLocaleString();
                            container.querySelector('.income-description').value = source.description || '';
                        }
                    });
                }
            }
            
            // Clear and repopulate dynamic lists
            // Clear all dynamic lists back to single empty row before repopulating
            function clearDynamicLists() {
                // Clear dependents (keep first row, remove others)
                const dependentsList = document.getElementById('dependentsList');
                const firstDependent = dependentsList.querySelector('.form-row-4');
                dependentsList.innerHTML = '';
                dependentsList.appendChild(firstDependent);
                // Clear the first row's values
                firstDependent.querySelector('.dependent-name').value = '';
                firstDependent.querySelector('.dependent-dob').value = '';
                firstDependent.querySelector('.dependent-edu-age').value = '18';
                firstDependent.querySelector('.dependent-study-years').value = '4';
                firstDependent.querySelector('.dependent-edu-cost').value = '$12,000.00';
                
                // Clear goals (keep first row, remove others)
                const goalsList = document.getElementById('goalsList');
                const firstGoal = goalsList.querySelector('.goal-item');
                goalsList.innerHTML = '';
                goalsList.appendChild(firstGoal);
                // Clear the first row's values
                firstGoal.querySelector('.goal-type').value = 'home';
                firstGoal.querySelector('.goal-years').value = '';
                firstGoal.querySelector('.goal-amount').value = '$0.00';
                firstGoal.querySelector('.goal-frequency').value = 'one-time';
                
                // Clear liquid assets (keep first row, remove others)
                const liquidAssetsList = document.getElementById('liquidAssetsList');
                const firstLiquidAsset = liquidAssetsList.querySelector('.asset-item');
                liquidAssetsList.innerHTML = '';
                liquidAssetsList.appendChild(firstLiquidAsset);
                // Clear the first row's values
                firstLiquidAsset.querySelector('.asset-type').value = 'rrsp';
                firstLiquidAsset.querySelector('.asset-value').value = '$0.00';
                firstLiquidAsset.querySelector('.asset-growth').value = '1.00%';
                firstLiquidAsset.querySelector('.asset-notes').value = '';
                
                // Clear fixed assets (keep first row, remove others)
                const fixedAssetsList = document.getElementById('fixedAssetsList');
                const firstFixedAsset = fixedAssetsList.querySelector('.asset-item');
                fixedAssetsList.innerHTML = '';
                fixedAssetsList.appendChild(firstFixedAsset);
                // Clear the first row's values
                firstFixedAsset.querySelector('.asset-type').value = 'primary-residence';
                firstFixedAsset.querySelector('.asset-value').value = '$0.00';
                firstFixedAsset.querySelector('.asset-growth').value = '3.00%';
                firstFixedAsset.querySelector('.asset-notes').value = '';
                
                // Clear liabilities (keep first row, remove others)
                const liabilitiesList = document.getElementById('liabilitiesList');
                const firstLiability = liabilitiesList.querySelector('.liability-item');
                liabilitiesList.innerHTML = '';
                liabilitiesList.appendChild(firstLiability);
                // Clear the first row's values
                firstLiability.querySelector('.liability-type').value = 'mortgage';
                firstLiability.querySelector('.liability-balance').value = '';
                firstLiability.querySelector('.liability-rate').value = '19.00';
                firstLiability.querySelector('.liability-payment').value = '';
                
                // Clear insurance (keep first row, remove others)
                const insuranceList = document.getElementById('insuranceList');
                const firstInsurance = insuranceList.querySelector('.form-row-6');
                insuranceList.innerHTML = '';
                insuranceList.appendChild(firstInsurance);
                // Clear the first row's values
                firstInsurance.querySelector('.insurance-type').value = 'term-life';
                firstInsurance.querySelector('.insurance-amount').value = '$0.00';
                firstInsurance.querySelector('.insurance-premium').value = '$0.00';
                firstInsurance.querySelector('.insurance-term').value = '';
                firstInsurance.querySelector('.insurance-owner').value = 'self';
                firstInsurance.querySelector('.insurance-beneficiary').value = '';
            }
            
            // Populate dependents
            if (data.family && data.family.dependents && data.family.dependents.length > 0) {
                data.family.dependents.forEach((dependent, index) => {
                    if (index > 0) addDependent();
                    const containers = document.querySelectorAll('#dependentsList .form-row-4');
                    const container = containers[index];
                    if (container) {
                        container.querySelector('.dependent-name').value = dependent.name || '';
                        container.querySelector('.dependent-dob').value = dependent.dob || '';
                        container.querySelector('.dependent-edu-age').value = dependent.eduAge || 18;
                        container.querySelector('.dependent-study-years').value = dependent.studyYears || 4;
                        container.querySelector('.dependent-edu-cost').value = '$' + (dependent.eduCost || 12000).toLocaleString();
                    }
                });
            }
            
            // Populate goals
            if (data.goals && data.goals.length > 0) {
                data.goals.forEach((goal, index) => {
                    if (index > 0) addGoal();
                    const containers = document.querySelectorAll('.goal-item');
                    const container = containers[index];
                    if (container) {
                        container.querySelector('.goal-type').value = goal.type || 'other';
                        container.querySelector('.goal-description').value = goal.description || '';
                        container.querySelector('.goal-years').value = goal.years || '';
                        container.querySelector('.goal-amount').value = '$' + (goal.amount || 0).toLocaleString();
                        container.querySelector('.goal-frequency').value = goal.frequency || 'one-time';
                    }
                });
            }
            
            // Populate assets (separate liquid and fixed)
            if (data.assets && data.assets.length > 0) {
                // Separate assets by category (backward compatibility for older saves)
                const liquidAssets = data.assets.filter(asset => 
                    !asset.category || asset.category === 'liquid' || 
                    ['rrsp', 'tfsa', 'non-registered', 'savings', 'pension', 'rdsp', 'resp', 'stocks', 'bonds', 'crypto'].includes(asset.type)
                );
                const fixedAssets = data.assets.filter(asset => 
                    asset.category === 'fixed' || 
                    ['primary-residence', 'rental-property', 'vacation-property', 'commercial-real-estate', 'business-ownership', 'vehicles', 'precious-metals', 'collectibles', 'intellectual-property', 'real-estate', 'business'].includes(asset.type)
                );
                
                // Populate liquid assets
                liquidAssets.forEach((asset, index) => {
                    if (index > 0) addLiquidAsset();
                    const containers = document.querySelectorAll('.liquid-asset');
                    const container = containers[index];
                    if (container) {
                        container.querySelector('.asset-type').value = asset.type || 'other-liquid';
                        container.querySelector('.asset-value').value = '$' + asset.value.toLocaleString() || '$0.00';
                        container.querySelector('.asset-growth').value = (asset.growth * 100).toFixed(2) + '%' || '1.00%';
                        container.querySelector('.asset-notes').value = asset.notes || '';
                    }
                });
                
                // Populate fixed assets
                fixedAssets.forEach((asset, index) => {
                    if (index > 0) addFixedAsset();
                    const containers = document.querySelectorAll('.fixed-asset');
                    const container = containers[index];
                    if (container) {
                        container.querySelector('.asset-type').value = asset.type || 'other-fixed';
                        container.querySelector('.asset-value').value = '$' + asset.value.toLocaleString() || '$0.00';
                        container.querySelector('.asset-growth').value = (asset.growth * 100).toFixed(2) + '%' || '3.00%';
                        container.querySelector('.asset-notes').value = asset.notes || '';
                    }
                });
            }
            
            // Populate liabilities (separate mortgages and other debts)
            if (data.liabilities && data.liabilities.length > 0) {
                // Separate mortgages from other liabilities
                const mortgages = data.liabilities.filter(item => item.type && item.type.startsWith('mortgage-'));
                const otherLiabilities = data.liabilities.filter(item => !item.type || !item.type.startsWith('mortgage-'));
                
                // Populate mortgages
                mortgages.forEach((mortgage, index) => {
                    if (index > 0) addMortgage();
                    const containers = document.querySelectorAll('.mortgage-item');
                    const container = containers[index];
                    if (container) {
                        const property = mortgage.type.replace('mortgage-', '');
                        container.querySelector('.mortgage-property').value = property || 'primary';
                        container.querySelector('.mortgage-original').value = '$' + (mortgage.original || 0).toLocaleString();
                        container.querySelector('.mortgage-balance').value = '$' + (mortgage.balance || 0).toLocaleString();
                        container.querySelector('.mortgage-rate').value = (mortgage.rate * 100).toFixed(2) || '';
                        container.querySelector('.mortgage-term').value = mortgage.term || '';
                        container.querySelector('.mortgage-payment').value = '$' + (mortgage.payment || 0).toLocaleString();
                        container.querySelector('.mortgage-maturity').value = mortgage.maturity || '';
                    }
                });
                
                // Populate other liabilities (secured/unsecured debts)
                otherLiabilities.forEach((liability, index) => {
                    // Determine if it's secured or unsecured debt and add accordingly
                    const isSecured = ['vehicle', 'vehicle-lease', 'boat', 'equipment', 'secured-loan', 'other-secured'].includes(liability.type);
                    if (index > 0) {
                        if (isSecured) {
                            addSecuredDebt();
                        } else {
                            addUnsecuredDebt();
                        }
                    }
                    
                    const className = isSecured ? 'secured-debt' : 'unsecured-debt';
                    const containers = document.querySelectorAll(`.liability-item.${className}`);
                    const container = containers[Math.floor(index / 2)]; // Approximate container selection
                    
                    if (container) {
                        container.querySelector('.liability-type').value = liability.type || 'other';
                        container.querySelector('.liability-balance').value = '$' + (liability.balance || 0).toLocaleString();
                        container.querySelector('.liability-rate').value = (liability.rate * 100).toFixed(2) || '';
                        container.querySelector('.liability-payment').value = '$' + (liability.payment || 0).toLocaleString();
                    }
                });
            }
            
            // Populate insurance
            if (data.insurance && data.insurance.length > 0) {
                data.insurance.forEach((policy, index) => {
                    if (index > 0) addInsurance();
                    const containers = document.querySelectorAll('#insuranceList .insurance-item');
                    const container = containers[index];
                    if (container) {
                        container.querySelector('.insurance-type').value = policy.type || 'term-life';
                        container.querySelector('.insurance-company').value = policy.company || '';
                        container.querySelector('.insurance-amount').value = '$' + (policy.amount || 0).toLocaleString();
                        container.querySelector('.insurance-premium').value = '$' + (policy.premium || 0).toLocaleString();
                        container.querySelector('.insurance-term').value = policy.term || '';
                        container.querySelector('.insurance-expiry').value = policy.expiry || '';
                        container.querySelector('.insurance-owner').value = policy.owner || 'self';
                        container.querySelector('.insurance-beneficiary').value = policy.beneficiary || '';
                        
                        // Trigger auto-population for whole life and universal life
                        updateInsuranceTerm(container.querySelector('.insurance-type'));
                    }
                });
            }
            
            // Populate insurance needs (partner-specific with backward compatibility)
            if (data.insuranceNeeds) {
                if (data.insuranceNeeds.partner1) {
                    // New format with partner-specific data
                    document.getElementById('finalExpenses1').value = 
                        '$' + (data.insuranceNeeds.partner1.finalExpenses || 15000).toLocaleString();
                    document.getElementById('incomeReplacement1').value = 
                        data.insuranceNeeds.partner1.incomeReplacement || 10;
                    document.getElementById('finalExpenses2').value = 
                        '$' + (data.insuranceNeeds.partner2.finalExpenses || 15000).toLocaleString();
                    document.getElementById('incomeReplacement2').value = 
                        data.insuranceNeeds.partner2.incomeReplacement || 10;
                } else {
                    // Backward compatibility - populate both partners with same values
                    document.getElementById('finalExpenses1').value = 
                        '$' + (data.insuranceNeeds.finalExpenses || 15000).toLocaleString();
                    document.getElementById('incomeReplacement1').value = 
                        data.insuranceNeeds.incomeReplacement || 10;
                    document.getElementById('finalExpenses2').value = 
                        '$' + (data.insuranceNeeds.finalExpenses || 15000).toLocaleString();
                    document.getElementById('incomeReplacement2').value = 
                        data.insuranceNeeds.incomeReplacement || 10;
                }
            }
            
            // Update income displays with loaded data
            updateIncomeDisplay();
        }
        
        function clearDynamicLists() {
            // Clear dependents (keep first one)
            const dependentsList = document.getElementById('dependentsList');
            const firstDependent = dependentsList.querySelector('.form-row-4');
            dependentsList.innerHTML = '';
            dependentsList.appendChild(firstDependent);
            
            // Clear goals (keep first one)
            const goalsList = document.getElementById('goalsList');
            const firstGoal = goalsList.querySelector('.goal-item');
            goalsList.innerHTML = '';
            goalsList.appendChild(firstGoal);
            
            // Clear liquid assets (keep first one)
            const liquidAssetsList = document.getElementById('liquidAssetsList');
            const firstLiquidAsset = liquidAssetsList.querySelector('.asset-item');
            liquidAssetsList.innerHTML = '';
            liquidAssetsList.appendChild(firstLiquidAsset);
            
            // Clear fixed assets (keep first one)
            const fixedAssetsList = document.getElementById('fixedAssetsList');
            const firstFixedAsset = fixedAssetsList.querySelector('.asset-item');
            fixedAssetsList.innerHTML = '';
            fixedAssetsList.appendChild(firstFixedAsset);
            
            // Clear liabilities (keep first one)
            const liabilitiesList = document.getElementById('liabilitiesList');
            const firstLiability = liabilitiesList.querySelector('.liability-item');
            liabilitiesList.innerHTML = '';
            liabilitiesList.appendChild(firstLiability);
            
            // Clear insurance (keep first one)
            const insuranceList = document.getElementById('insuranceList');
            const firstInsurance = insuranceList.querySelector('.form-row-6');
            insuranceList.innerHTML = '';
            insuranceList.appendChild(firstInsurance);
        }
        
        function generatePrintSummary() {
            if (!window.currentCalculations) {
                alert('Please calculate your FNA first!');
                return;
            }
            alert('Print functionality temporarily disabled - date formatting is now working!');
            // TODO: Implement proper print summary generation
            return;
        }
        
        
        // Enhanced percentage formatting for input fields
        function addPercentageFormatting() {
            // Find all percentage input fields
            const percentageSelectors = [
                'input[id*="Rate"]:not([id*="income"])',  // All rates except income rates
                'input[id*="Percent"]',
                'input[id*="retirementIncome"]',
                'input[id*="widowReduction"]',
                'input[id*="registeredTax"]',
                'input[id*="blendedTax"]',
                'input[id*="inflation"]',
                'input[id*="preRetire"]',
                'input[id*="postRetire"]'
            ];
            
            const percentageFields = document.querySelectorAll(percentageSelectors.join(', '));
            
            percentageFields.forEach(field => {
                // Convert to text input for better formatting control
                if (field.type === 'number') {
                    field.type = 'text';
                }
                
                // Skip if already formatted
                if (field.dataset.percentFormatted) return;
                field.dataset.percentFormatted = 'true';
                
                // Format existing value if any
                if (field.value && !field.value.includes('%')) {
                    formatPercentageValue(field);
                }
                
                field.addEventListener('input', function(e) {
                    formatPercentageValue(e.target);
                });
                
                field.addEventListener('blur', function(e) {
                    formatPercentageValue(e.target, true);
                });
            });
        }
        
        // Simple percentage formatting function for onchange events
        function formatPercentage(field) {
            formatPercentageValue(field, true);
        }
        
        // Remove debt item function
        function removeDebtItem(button) {
            const debtItem = button.closest('.liability-item');
            if (debtItem) {
                debtItem.remove();
            }
        }
        
        
        // Enhanced percentage formatting function
        function formatPercentageValue(field, onBlur = false) {
            let value = field.value.replace(/[^0-9.-]/g, ''); // Allow negative sign
            
            // Handle empty input
            if (value === '' || value === '-') {
                if (onBlur) {
                    field.value = '0.00%';
                }
                return;
            }
            
            // Handle negative sign positioning
            let isNegative = value.startsWith('-');
            if (isNegative) {
                value = value.substring(1);
            }
            
            // Ensure only one decimal point
            let parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // Limit decimal places to 2
            if (parts.length === 2 && parts[1].length > 2) {
                value = parts[0] + '.' + parts[1].substring(0, 2);
            }
            
            let numValue = parseFloat(value);
            if (!isNaN(numValue)) {
                if (isNegative) numValue = -numValue;
                
                if (onBlur) {
                    // Final formatting with 2 decimal places
                    field.value = numValue.toFixed(2) + '%';
                } else {
                    // Real-time formatting (flexible decimal places)
                    const decimals = parts.length > 1 ? Math.min(parts[1].length, 2) : 0;
                    field.value = numValue.toFixed(decimals) + '%';
                }
            } else if (onBlur && field.value !== '') {
                field.value = '0.00%';
            }
        }
        
        // Real-time currency formatting for input fields
        function addCurrencyFormatting() {
            // Enhanced selector to catch all currency fields
            const currencySelectors = [
                // Direct placeholder matches
                'input[placeholder*="$"]',
                'input[placeholder*="Amount"]',
                'input[placeholder*="Monthly Amount"]',
                // Specific ID patterns  
                'input[id*="income"][id*="Rate"]',  // Income rate fields
                'input[id*="finalExpenses"]',
                'input[id*="downsizeValue"]',
                'input[id*="retirementRent"]',
                'input[id*="cpp"]',
                'input[id*="oas"]',
                // Class-based selectors
                '.asset-value',
                '.liability-amount', 
                '.liability-balance',
                '.liability-payment',
                '.goal-amount',
                '.insurance-amount',
                '.insurance-premium',
                '.income-amount',
                '.dependent-edu-cost',
                // Any input that should be currency based on step values
                'input[step="1000"]',
                'input[step="10000"]',
                'input[step="5000"]',
                'input[step="100"]'
            ];
            
            const currencyFields = document.querySelectorAll(currencySelectors.join(', '));
            
            currencyFields.forEach(field => {
                // Convert to text input for better formatting control
                if (field.type === 'number') {
                    field.type = 'text';
                }
                
                // Skip if already formatted
                if (field.dataset.formatted) return;
                field.dataset.formatted = 'true';
                
                // Format existing value if any
                if (field.value && !field.value.includes('$')) {
                    formatCurrencyValue(field);
                }
                
                field.addEventListener('input', function(e) {
                    formatCurrencyValue(e.target);
                });
                
                field.addEventListener('blur', function(e) {
                    formatCurrencyValue(e.target, true);
                });
            });
        }
        
        // Enhanced currency formatting function
        function formatCurrencyValue(field, onBlur = false) {
            let value = field.value.replace(/[^0-9.]/g, '');
            
            // Handle empty input
            if (value === '') {
                if (onBlur) {
                    field.value = '$0.00';
                }
                return;
            }
            
            // Ensure only one decimal point
            let parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // Limit decimal places to 2
            if (parts.length === 2 && parts[1].length > 2) {
                value = parts[0] + '.' + parts[1].substring(0, 2);
            }
            
            let numValue = parseFloat(value);
            if (!isNaN(numValue)) {
                if (onBlur) {
                    // Final formatting with 2 decimal places
                    field.value = '$' + numValue.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                } else {
                    // Real-time formatting (flexible decimal places)
                    const decimals = parts.length > 1 ? Math.min(parts[1].length, 2) : 0;
                    field.value = '$' + numValue.toLocaleString('en-US', {
                        minimumFractionDigits: decimals,
                        maximumFractionDigits: decimals
                    });
                }
            } else if (onBlur && field.value !== '') {
                field.value = '$0.00';
            }
        }
        
        // Main initialization function
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize field formatting
            addCurrencyFormatting();
            addPercentageFormatting();
            
            // Initialize save flag
            window.dataSaved = false;
            
            // Initialize blank charts
            initializeBlankCharts();
            
            // Initialize DIME calculations and partner names
            setTimeout(() => {
                updatePartnerNames();
                updateDimeCalculations();
            }, 500);
            
            // Initialize blended tax rate calculation
            updateBlendedTaxRate();
            
            // Add event listeners to reset save flag when data changes
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('input', function() {
                    window.dataSaved = false;
                });
                form.addEventListener('change', function() {
                    window.dataSaved = false;
                });
            }
            
            // Also listen for changes on the whole document (for dynamically added elements)
            document.addEventListener('input', function(e) {
                if (e.target.matches('input, select, textarea')) {
                    window.dataSaved = false;
                }
            });
            document.addEventListener('change', function(e) {
                if (e.target.matches('input, select, textarea')) {
                    window.dataSaved = false;
                }
            });
        });
        
        // Re-apply formatting when new elements are added dynamically
        const originalAddAsset = addAsset;
        const originalAddLiquidAsset = addLiquidAsset;
        const originalAddFixedAsset = addFixedAsset;
        const originalAddMortgage = addMortgage;
        const originalAddSecuredDebt = addSecuredDebt;
        const originalAddUnsecuredDebt = addUnsecuredDebt;
        const originalAddGoal = addGoal;
        const originalAddLiability = addLiability;
        const originalAddIncomeSource = addIncomeSource;
        
        if (typeof addAsset === 'function') {
            addAsset = function() {
                originalAddAsset();
                setTimeout(() => {
                    addCurrencyFormatting();
                    addPercentageFormatting();
                }, 100);
            };
        }
        
        if (typeof addLiquidAsset === 'function') {
            addLiquidAsset = function() {
                originalAddLiquidAsset();
                setTimeout(() => {
                    addCurrencyFormatting();
                    addPercentageFormatting();
                }, 100);
            };
        }
        
        if (typeof addFixedAsset === 'function') {
            addFixedAsset = function() {
                originalAddFixedAsset();
                setTimeout(() => {
                    addCurrencyFormatting();
                    addPercentageFormatting();
                }, 100);
            };
        }
        
        if (typeof addMortgage === 'function') {
            addMortgage = function() {
                originalAddMortgage();
                setTimeout(() => {
                    addCurrencyFormatting();
                    addPercentageFormatting();
                }, 100);
            };
        }
        
        if (typeof addSecuredDebt === 'function') {
            addSecuredDebt = function() {
                originalAddSecuredDebt();
                setTimeout(() => {
                    addCurrencyFormatting();
                    addPercentageFormatting();
                }, 100);
            };
        }
        
        if (typeof addUnsecuredDebt === 'function') {
            addUnsecuredDebt = function() {
                originalAddUnsecuredDebt();
                setTimeout(() => {
                    addCurrencyFormatting();
                    addPercentageFormatting();
                }, 100);
            };
        }
        
        if (typeof addGoal === 'function') {
            addGoal = function() {
                originalAddGoal();
                setTimeout(() => {
                    addCurrencyFormatting();
                    addPercentageFormatting();
                }, 100);
            };
        }
        
        if (typeof addLiability === 'function') {
            addLiability = function() {
                originalAddLiability();
                setTimeout(() => {
                    addCurrencyFormatting();
                    addPercentageFormatting();
                }, 100);
            };
        }
        
        if (typeof addIncomeSource === 'function') {
            addIncomeSource = function() {
                originalAddIncomeSource();
                setTimeout(() => {
                    addCurrencyFormatting();
                    addPercentageFormatting();
                }, 100);
            };
        }
    </script>
</body>
</html>